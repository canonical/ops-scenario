<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/favicon.png"/><!-- Generated with Sphinx 8.0.2 and Furo 2024.08.06 -->
        <title>ops.pebble - Scenario documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/youtube.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/related-links.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/terminal-output.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=8885841a" />
    <link rel="stylesheet" type="text/css" href="../../_static/header.css?v=84f70f09" />
    <link rel="stylesheet" type="text/css" href="../../_static/github_issue_links.css?v=af88fb93" />
    <link rel="stylesheet" type="text/css" href="../../_static/furo_colors.css?v=090a1488" />
    
</head>
  <body>
    <header id="header" class="p-navigation">

  <div class="p-navigation__nav" role="menubar">

    <ul class="p-navigation__links" role="menu">

      <li>
        <a class="p-logo" href="https://juju.is/docs/sdk" aria-current="page">
          <img src="../../_static/tag.png" alt="Logo" class="p-logo-image">
          <div class="p-logo-text p-heading--4">Scenario
          </div>
        </a>
      </li>

      <li class="nav-ubuntu-com">
        <a href="https://juju.is/docs/sdk" class="p-navigation__link">juju.is/docs/sdk</a>
      </li>

      <li>
        <a href="#" class="p-navigation__link nav-more-links">More resources</a>
        <ul class="more-links-dropdown">

          <li>
            <a href="https://discourse.charmhub.io/" class="p-navigation__sub-link p-dropdown__link">Forum</a>
          </li>

          <li>
            <a href="https://github.com/canonical/ops-scenario" class="p-navigation__sub-link p-dropdown__link">GitHub</a>
          </li>

        </ul>
      </li>

    </ul>
  </div>
</header>
   
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Scenario documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Scenario documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
    <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
    <input type="submit" value="Go">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
  <div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for ops.pebble</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2021 Canonical Ltd.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Client for the Pebble API (HTTP over Unix socket).</span>

<span class="sd">For a command-line interface for local testing, see test/pebble_cli.py.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">email.message</span>
<span class="kn">import</span> <span class="nn">email.parser</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">http.client</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IO</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AnyStr</span><span class="p">,</span>
    <span class="n">BinaryIO</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Protocol</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">TextIO</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">TypedDict</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">websocket</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">ops._private</span> <span class="kn">import</span> <span class="n">timeconv</span><span class="p">,</span> <span class="n">yaml</span>

<span class="c1"># Public as these are used in the Container.add_layer signature</span>
<span class="n">ServiceDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;ServiceDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;startup&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;override&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;after&#39;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;before&#39;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;group-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;working-dir&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;on-success&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;on-failure&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;on-check-failure&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="s1">&#39;backoff-delay&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;backoff-factor&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;backoff-limit&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;kill-delay&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">HttpDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;HttpDict&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]},</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">TcpDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;TcpDict&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ExecDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;ExecDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="c1"># see JujuVersion.supports_exec_service_context</span>
        <span class="s1">&#39;service-context&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;group-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;working-dir&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">CheckDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;CheckDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;override&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;CheckLevel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HttpDict</span><span class="p">],</span>
        <span class="s1">&#39;tcp&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TcpDict</span><span class="p">],</span>
        <span class="s1">&#39;exec&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExecDict</span><span class="p">],</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># In Python 3.11+ &#39;services&#39; and &#39;labels&#39; should be NotRequired, and total=True.</span>
<span class="n">LogTargetDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;LogTargetDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;override&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;replace&#39;</span><span class="p">]],</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;loki&#39;</span><span class="p">],</span>
        <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">LayerDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;LayerDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ServiceDict</span><span class="p">],</span>
        <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CheckDict</span><span class="p">],</span>
        <span class="s1">&#39;log-targets&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LogTargetDict</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">PlanDict</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;PlanDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ServiceDict</span><span class="p">],</span>
        <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CheckDict</span><span class="p">],</span>
        <span class="s1">&#39;log-targets&#39;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LogTargetDict</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_AuthDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;_AuthDict&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;group-id&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s1">&#39;make-dirs&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="s1">&#39;make-parents&#39;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_ServiceInfoDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
    <span class="s1">&#39;_ServiceInfoDict&#39;</span><span class="p">,</span>
    <span class="p">{</span><span class="s1">&#39;startup&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;ServiceStartup&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;ServiceStatus&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Callback types for _MultiParser header and body handlers</span>


<span class="k">class</span> <span class="nc">_BodyHandler</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>


<span class="n">_HeaderHandler</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>

<span class="c1"># tempfile.NamedTemporaryFile has an odd interface because of that</span>
<span class="c1"># &#39;name&#39; attribute, so we need to make a Protocol for it.</span>


<span class="k">class</span> <span class="nc">_Tempfile</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span>


<span class="k">class</span> <span class="nc">_FileLikeIO</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">AnyStr</span><span class="p">]):</span>  <span class="c1"># That also covers TextIO and BytesIO</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">AnyStr</span><span class="p">:</span> <span class="o">...</span>  <span class="c1"># for BinaryIO</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__s</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">AnyStr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">AnyStr</span><span class="p">]:</span> <span class="o">...</span>


<span class="n">_AnyStrFileLikeIO</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">_FileLikeIO</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">_FileLikeIO</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_TextOrBinaryIO</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">TextIO</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">]</span>
<span class="n">_IOSource</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">_AnyStrFileLikeIO</span><span class="p">]</span>

<span class="n">_SystemInfoDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;_SystemInfoDict&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">NotRequired</span>

    <span class="n">_CheckInfoDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_CheckInfoDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;CheckLevel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;CheckStatus&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s1">&#39;change-id&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">_FileInfoDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_FileInfoDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;last-modified&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;group-id&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;FileType&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">_ProgressDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;_ProgressDict&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
    <span class="n">_TaskDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_TaskDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
            <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="n">_ProgressDict</span><span class="p">,</span>
            <span class="s1">&#39;spawn-time&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;ready-time&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">_ChangeDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_ChangeDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;ready&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s1">&#39;spawn-time&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">_TaskDict</span><span class="p">]]],</span>
            <span class="s1">&#39;err&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;ready-time&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">_Error</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;_Error&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
    <span class="n">_Item</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;_Item&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">_Error</span><span class="p">]})</span>
    <span class="n">_FilesResponse</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Item</span><span class="p">]})</span>

    <span class="n">_WarningDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_WarningDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;first-added&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;last-added&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;last-shown&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="s1">&#39;expire-after&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;repeat-after&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">_NoticeDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s1">&#39;_NoticeDict&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;first-occurred&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;last-occurred&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;last-repeated&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;occurrences&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s1">&#39;last-data&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
            <span class="s1">&#39;repeat-after&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="s1">&#39;expire-after&#39;</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">_WebSocket</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">send_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_NotProvidedFlag</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">_not_provided</span> <span class="o">=</span> <span class="n">_NotProvidedFlag</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_UnixSocketConnection</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of HTTPConnection that connects to a named Unix socket.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NotProvidedFlag</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">_not_provided</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">_not_provided</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> <span class="n">timeout</span>  <span class="c1"># type guard for pyright</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span> <span class="o">=</span> <span class="n">socket_path</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override connect to use Unix socket (instead of TCP socket).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;AF_UNIX&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unix sockets not supported on </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_not_provided</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_UnixSocketHandler</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">AbstractHTTPHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of HTTPHandler that uses a named Unix socket.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span> <span class="o">=</span> <span class="n">socket_path</span>

    <span class="k">def</span> <span class="nf">http_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override http_open to use a Unix socket connection (instead of TCP).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_open</span><span class="p">(</span>
            <span class="n">_UnixSocketConnection</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
            <span class="n">req</span><span class="p">,</span>
            <span class="n">socket_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format timeout for use in the Pebble API.</span>

<span class="sd">    The format is in seconds with a millisecond resolution and an &#39;s&#39; suffix,</span>
<span class="sd">    as accepted by the Pebble API (which uses Go&#39;s time.ParseDuration).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">timeout</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">s&#39;</span>


<span class="k">def</span> <span class="nf">_start_thread</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to simplify starting a thread.&quot;&quot;&quot;</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">thread</span>


<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class of most errors raised by the Pebble client.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s1">&gt;&#39;</span>


<span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a polling timeout occurs.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ConnectionError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the Pebble client can&#39;t connect to the socket.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ProtocolError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when there&#39;s a higher-level protocol error talking to Pebble.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">PathError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when there&#39;s an error with a specific path.&quot;&quot;&quot;</span>

    <span class="n">kind</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;not-found&#39;</span><span class="p">,</span> <span class="s1">&#39;permission-denied&#39;</span><span class="p">,</span> <span class="s1">&#39;generic-file-error&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short string representing the kind of error.&quot;&quot;&quot;</span>

    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Human-readable error message from the API.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This shouldn&#39;t be instantiated directly.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;PathError(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">APIError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an HTTP API error occurs talking to the Pebble server.&quot;&quot;&quot;</span>

    <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Body of the HTTP response, parsed as JSON.&quot;&quot;&quot;</span>

    <span class="n">code</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HTTP status code.&quot;&quot;&quot;</span>

    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HTTP status string (reason).&quot;&quot;&quot;</span>

    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Human-readable error message from the API.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This shouldn&#39;t be instantiated directly.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># Makes str(e) return message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;APIError(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">ChangeError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised by actions when a change is ready but has an error.&quot;&quot;&quot;</span>

    <span class="n">err</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Human-readable error message.&quot;&quot;&quot;</span>

    <span class="n">change</span><span class="p">:</span> <span class="s1">&#39;Change&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change object associated with this error.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">change</span><span class="p">:</span> <span class="s1">&#39;Change&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This shouldn&#39;t be instantiated directly.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change</span> <span class="o">=</span> <span class="n">change</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">]</span>

        <span class="c1"># Append any task logs to the error message</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">----- Logs from task </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> -----</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ChangeError(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">change</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">ExecError</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a :meth:`Client.exec` command returns a non-zero exit code.&quot;&quot;&quot;</span>

    <span class="n">STR_MAX_OUTPUT</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum number of characters that stdout/stderr are truncated to in ``__str__``.&quot;&quot;&quot;</span>

    <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Command line of command being executed.&quot;&quot;&quot;</span>

    <span class="n">exit_code</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The process&#39;s exit code. Because this is an error, this will always be non-zero.&quot;&quot;&quot;</span>

    <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard output from the process.</span>

<span class="sd">    If :meth:`ExecProcess.wait_output` was being called, this is the captured</span>
<span class="sd">    stdout as a str (or bytes if encoding was None). If :meth:`ExecProcess.wait`</span>
<span class="sd">    was being called, this is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard error from the process.</span>

<span class="sd">    If :meth:`ExecProcess.wait_output` was being called and ``combine_stderr``</span>
<span class="sd">    was False, this is the captured stderr as a str (or bytes if encoding was</span>
<span class="sd">    None). If :meth:`ExecProcess.wait` was being called or ``combine_stderr``</span>
<span class="sd">    was True, this is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exit_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">exit_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;non-zero exit code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="si">}</span><span class="s1"> executing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="si">!r}</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;stdout&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="s1">&#39; [truncated]&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STR_MAX_OUTPUT</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">STR_MAX_OUTPUT</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">out</span><span class="si">!r}{</span><span class="n">truncated</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">message</span>


<span class="k">class</span> <span class="nc">WarningState</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of states for get_warnings() select parameter.&quot;&quot;&quot;</span>

    <span class="n">ALL</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span>


<span class="k">class</span> <span class="nc">ChangeState</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of states for get_changes() select parameter.&quot;&quot;&quot;</span>

    <span class="n">ALL</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">IN_PROGRESS</span> <span class="o">=</span> <span class="s1">&#39;in-progress&#39;</span>
    <span class="n">READY</span> <span class="o">=</span> <span class="s1">&#39;ready&#39;</span>


<span class="k">class</span> <span class="nc">SystemInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;System information object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_SystemInfoDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SystemInfo&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new SystemInfo object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;SystemInfo(version=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">Warning</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warning object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">first_added</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">last_added</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">last_shown</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
        <span class="n">expire_after</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">repeat_after</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_added</span> <span class="o">=</span> <span class="n">first_added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_added</span> <span class="o">=</span> <span class="n">last_added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_shown</span> <span class="o">=</span> <span class="n">last_shown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expire_after</span> <span class="o">=</span> <span class="n">expire_after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat_after</span> <span class="o">=</span> <span class="n">repeat_after</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_WarningDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Warning&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new Warning object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">],</span>
            <span class="n">first_added</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;first-added&#39;</span><span class="p">]),</span>
            <span class="n">last_added</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;last-added&#39;</span><span class="p">]),</span>
            <span class="n">last_shown</span><span class="o">=</span><span class="p">(</span>
                <span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;last-shown&#39;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last-shown&#39;</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">expire_after</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;expire-after&#39;</span><span class="p">],</span>
            <span class="n">repeat_after</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;repeat-after&#39;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;Warning(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;message=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;first_added=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">first_added</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;last_added=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_added</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;last_shown=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_shown</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;expire_after=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expire_after</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;repeat_after=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat_after</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskProgress</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task progress object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">done</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">total</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_ProgressDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;TaskProgress&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new TaskProgress object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
            <span class="n">done</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">],</span>
            <span class="n">total</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;TaskProgress(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;label=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;done=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;total=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskID</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task ID (a more strongly-typed string).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TaskID(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">TaskProgress</span><span class="p">,</span>
        <span class="n">spawn_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">ready_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_time</span> <span class="o">=</span> <span class="n">spawn_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready_time</span> <span class="o">=</span> <span class="n">ready_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_TaskDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Task&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new Task object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">TaskID</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
            <span class="n">status</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
            <span class="n">log</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">TaskProgress</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]),</span>
            <span class="n">spawn_time</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;spawn-time&#39;</span><span class="p">]),</span>
            <span class="n">ready_time</span><span class="o">=</span><span class="p">(</span>
                <span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ready-time&#39;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ready-time&#39;</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;Task(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;kind=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;summary=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;log=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;progress=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;spawn_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spawn_time</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;ready_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ready_time</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;data=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ChangeID</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change ID (a more strongly-typed string).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ChangeID(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">Change</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Task</span><span class="p">],</span>
        <span class="n">ready</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">err</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">spawn_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">ready_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_time</span> <span class="o">=</span> <span class="n">spawn_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready_time</span> <span class="o">=</span> <span class="n">ready_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_ChangeDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Change&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new Change object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">ChangeID</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
            <span class="n">status</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
            <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">Task</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]],</span>
            <span class="n">ready</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">],</span>
            <span class="n">err</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;err&#39;</span><span class="p">),</span>
            <span class="n">spawn_time</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;spawn-time&#39;</span><span class="p">]),</span>
            <span class="n">ready_time</span><span class="o">=</span><span class="p">(</span>
                <span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ready-time&#39;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ready-time&#39;</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;Change(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;kind=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;summary=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;tasks=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;ready=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;err=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;spawn_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spawn_time</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;ready_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ready_time</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;data=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the effective Pebble configuration.</span>

<span class="sd">    A plan is the combined layer configuration. The layer configuration is</span>
<span class="sd">    documented at https://github.com/canonical/pebble/#layer-specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;PlanDict&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># noqa: SIM108</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">raw</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;PlanDict&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="n">raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Service</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_targets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LogTarget</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">LogTarget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log-targets&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">services</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Service&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This plan&#39;s services mapping (maps service name to Service).</span>

<span class="sd">        This property is currently read-only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Check&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This plan&#39;s checks mapping (maps check name to :class:`Check`).</span>

<span class="sd">        This property is currently read-only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;LogTarget&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This plan&#39;s log targets mapping (maps log target name to :class:`LogTarget`).</span>

<span class="sd">        This property is currently read-only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_targets</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;PlanDict&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this plan to its dict representation.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">service</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
            <span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">check</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checks</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
            <span class="p">(</span>
                <span class="s1">&#39;log-targets&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;PlanDict&#39;</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return this plan&#39;s YAML representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="n">to_yaml</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;PlanDict&#39;</span><span class="p">,</span> <span class="s1">&#39;Plan&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Plan</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>


<span class="k">class</span> <span class="nc">Layer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Pebble configuration layer.</span>

<span class="sd">    The format of this is documented at</span>
<span class="sd">    https://github.com/canonical/pebble/#layer-specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Summary of the purpose of this layer.</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#: Long-form description of this layer.</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#: Mapping of name to :class:`Service` defined by this layer.</span>
    <span class="n">services</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Service&#39;</span><span class="p">]</span>
    <span class="c1">#: Mapping of check to :class:`Check` defined by this layer.</span>
    <span class="n">checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Check&#39;</span><span class="p">]</span>
    <span class="c1">#: Mapping of target to :class:`LogTarget` defined by this layer.</span>
    <span class="n">log_targets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;LogTarget&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;LayerDict&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># noqa: SIM108</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: ignore # (Any &#39;raw&#39; type)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">raw</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;LayerDict&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">Check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_targets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">LogTarget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log-targets&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this layer to its YAML representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LayerDict&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this layer to its dict representation.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">service</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
            <span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">check</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
            <span class="p">(</span><span class="s1">&#39;log-targets&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
        <span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;LayerDict&#39;</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Layer(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">!r}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;LayerDict&#39;</span><span class="p">,</span> <span class="s1">&#39;Layer&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reports whether this layer configuration is equal to another.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="n">to_yaml</span>


<span class="k">class</span> <span class="nc">Service</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a service description in a Pebble configuration layer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;ServiceDict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">dct</span><span class="p">:</span> <span class="n">ServiceDict</span> <span class="o">=</span> <span class="n">raw</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;startup&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user-id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group-id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;working-dir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_success</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on-success&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on-failure&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_check_failure</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on-check-failure&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backoff_delay</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backoff-delay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backoff-factor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backoff_limit</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backoff-limit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill_delay</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kill-delay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ServiceDict&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this service object to its dict representation.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;startup&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">startup</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;requires&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;user-id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;group-id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_id</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;working-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;on-success&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_success</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;on-failure&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;on-check-failure&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_check_failure</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;backoff-delay&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backoff_delay</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;backoff-factor&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;backoff-limit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backoff_limit</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;kill-delay&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_delay</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;ServiceDict&#39;</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Service&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this service object with another service definition.</span>

<span class="sd">        For attributes present in both objects, the passed in service</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;requires&#39;</span><span class="p">]:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;on_check_failure&#39;</span><span class="p">]:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Service(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">!r}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;ServiceDict&#39;</span><span class="p">,</span> <span class="s1">&#39;Service&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reports whether this service configuration is equal to another.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Service</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>


<span class="k">class</span> <span class="nc">ServiceStartup</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of service startup options.&quot;&quot;&quot;</span>

    <span class="n">ENABLED</span> <span class="o">=</span> <span class="s1">&#39;enabled&#39;</span>
    <span class="n">DISABLED</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span>


<span class="k">class</span> <span class="nc">ServiceStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of service statuses.&quot;&quot;&quot;</span>

    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span>
    <span class="n">INACTIVE</span> <span class="o">=</span> <span class="s1">&#39;inactive&#39;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>


<span class="k">class</span> <span class="nc">ServiceInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service status information.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">startup</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServiceStartup</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">current</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServiceStatus</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup</span> <span class="o">=</span> <span class="n">startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">current</span>

    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this service is running (in the active state).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">==</span> <span class="n">ServiceStatus</span><span class="o">.</span><span class="n">ACTIVE</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_ServiceInfoDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ServiceInfo&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new ServiceInfo object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">startup</span> <span class="o">=</span> <span class="n">ServiceStartup</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;startup&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">startup</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;startup&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">ServiceStatus</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">startup</span><span class="o">=</span><span class="n">startup</span><span class="p">,</span>
            <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;ServiceInfo(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;startup=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">startup</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;current=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">Check</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a check in a Pebble configuration layer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;CheckDict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">dct</span><span class="p">:</span> <span class="n">CheckDict</span> <span class="o">=</span> <span class="n">raw</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">CheckLevel</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">CheckLevel</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>

        <span class="n">http</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">http</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">http</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HttpDict</span><span class="p">]</span> <span class="o">=</span> <span class="n">http</span>

        <span class="n">tcp</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tcp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tcp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tcp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TcpDict</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcp</span>

        <span class="n">exec_</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exec_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exec_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">exec_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExecDict</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CheckDict&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this check object to its dict representation.&quot;&quot;&quot;</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">CheckLevel</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;CheckDict&#39;</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Check(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">!r}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;CheckDict&#39;</span><span class="p">,</span> <span class="s1">&#39;Check&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reports whether this check configuration is equal to another.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Check</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">_merge_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;ExecDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this exec object with another exec definition.</span>

<span class="sd">        For attributes present in both objects, the passed in exec</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;environment&#39;</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">current</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_merge_http</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;HttpDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this http object with another http definition.</span>

<span class="sd">        For attributes present in both objects, the passed in http</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">http</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;headers&#39;</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">current</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_merge_tcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;TcpDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this tcp object with another tcp definition.</span>

<span class="sd">        For attributes present in both objects, the passed in tcp</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Check&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this check object with another check definition.</span>

<span class="sd">        For attributes present in both objects, the passed in check</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;http&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_http</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;tcp&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_tcp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;exec&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_exec</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckLevel</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of check levels.&quot;&quot;&quot;</span>

    <span class="n">UNSET</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ALIVE</span> <span class="o">=</span> <span class="s1">&#39;alive&#39;</span>
    <span class="n">READY</span> <span class="o">=</span> <span class="s1">&#39;ready&#39;</span>


<span class="k">class</span> <span class="nc">CheckStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of check statuses.&quot;&quot;&quot;</span>

    <span class="n">UP</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
    <span class="n">DOWN</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>


<span class="k">class</span> <span class="nc">LogTarget</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a log target in a Pebble configuration layer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;LogTargetDict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">dct</span><span class="p">:</span> <span class="n">LogTargetDict</span> <span class="o">=</span> <span class="n">raw</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LogTargetDict&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert this log target object to its dict representation.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;LogTargetDict&#39;</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;LogTarget(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">!r}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;LogTargetDict&#39;</span><span class="p">,</span> <span class="s1">&#39;LogTarget&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">LogTarget</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;LogTarget&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges this log target object with another log target definition.</span>

<span class="sd">        For attributes present in both objects, the passed in log target</span>
<span class="sd">        attributes take precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;services&#39;</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of file types.&quot;&quot;&quot;</span>

    <span class="n">FILE</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
    <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="s1">&#39;directory&#39;</span>
    <span class="n">SYMLINK</span> <span class="o">=</span> <span class="s1">&#39;symlink&#39;</span>
    <span class="n">SOCKET</span> <span class="o">=</span> <span class="s1">&#39;socket&#39;</span>
    <span class="n">NAMED_PIPE</span> <span class="o">=</span> <span class="s1">&#39;named-pipe&#39;</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">&#39;device&#39;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>


<span class="k">class</span> <span class="nc">FileInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stat-like information about a single file or directory.&quot;&quot;&quot;</span>

    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Full path of the file.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base name of the file.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;FileType&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of the file (&quot;file&quot;, &quot;directory&quot;, &quot;symlink&quot;, etc).&quot;&quot;&quot;</span>

    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Size of the file (will be 0 if ``type`` is not &quot;file&quot;).&quot;&quot;&quot;</span>

    <span class="n">permissions</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unix permissions of the file.&quot;&quot;&quot;</span>

    <span class="n">last_modified</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Time file was last modified.&quot;&quot;&quot;</span>

    <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User ID of the file.&quot;&quot;&quot;</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Username of the file.&quot;&quot;&quot;</span>

    <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group ID of the file.&quot;&quot;&quot;</span>

    <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group name of the file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;FileType&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">last_modified</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">permissions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">last_modified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">group_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_FileInfoDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FileInfo&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new FileInfo object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_type</span> <span class="o">=</span> <span class="n">FileType</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">file_type</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">file_type</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">),</span>
            <span class="n">permissions</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">],</span> <span class="mi">8</span><span class="p">),</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;last-modified&#39;</span><span class="p">]),</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user-id&#39;</span><span class="p">),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span>
            <span class="n">group_id</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group-id&#39;</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;FileInfo(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;path=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;permissions=0o</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="si">:</span><span class="s1">o</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;last_modified=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;user_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;user=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;group_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">group_id</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;group=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check status information.</span>

<span class="sd">    A list of these objects is returned from :meth:`Client.get_checks`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the check.&quot;&quot;&quot;</span>

    <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CheckLevel</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check level.</span>

<span class="sd">    This can be :attr:`CheckLevel.ALIVE`, :attr:`CheckLevel.READY`, or None (level not set).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">CheckStatus</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status of the check.</span>

<span class="sd">    :attr:`CheckStatus.UP` means the check is healthy (the number of failures</span>
<span class="sd">    is less than the threshold), :attr:`CheckStatus.DOWN` means the check is</span>
<span class="sd">    unhealthy (the number of failures has reached the threshold).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">failures</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of failures since the check last succeeded.</span>

<span class="sd">    This is reset to zero if the check succeeds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Failure threshold.</span>

<span class="sd">    This is how many consecutive failures for the check to be considered &quot;down&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">change_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChangeID</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change ID of ``perform-check`` or ``recover-check`` change driving this check.</span>

<span class="sd">    This will be None on older versions of Pebble, which did not use changes</span>
<span class="sd">    to drive health checks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CheckLevel</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">CheckStatus</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">failures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">change_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChangeID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failures</span> <span class="o">=</span> <span class="n">failures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_id</span> <span class="o">=</span> <span class="n">change_id</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_CheckInfoDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CheckInfo&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new :class:`CheckInfo` object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">CheckLevel</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">CheckStatus</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">failures</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;failures&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
            <span class="n">change_id</span><span class="o">=</span><span class="n">ChangeID</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;change-id&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;change-id&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;CheckInfo(&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;failures=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;threshold=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;change_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">change_id</span><span class="si">!r}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">NoticeType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of notice types.&quot;&quot;&quot;</span>

    <span class="n">CUSTOM</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A custom notice reported via the Pebble client API or ``pebble notify``.</span>
<span class="sd">    The key and data fields are provided by the user. The key must be in</span>
<span class="sd">    the format ``example.com/path`` to ensure well-namespaced notice keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CHANGE_UPDATE</span> <span class="o">=</span> <span class="s1">&#39;change-update&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recorded whenever a change&#39;s status is updated. The key for change-update</span>
<span class="sd">    notices is the change ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">NoticesUsers</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of :meth:`Client.get_notices` ``users`` values.&quot;&quot;&quot;</span>

    <span class="n">ALL</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return notices from all users (any user ID, including public notices).</span>

<span class="sd">    This only works for Pebble admins (for example, root).</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ChangeKind</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of Pebble Change kinds.&quot;&quot;&quot;</span>

    <span class="n">START</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span>
    <span class="n">RESTART</span> <span class="o">=</span> <span class="s1">&#39;restart&#39;</span>
    <span class="n">REPLAN</span> <span class="o">=</span> <span class="s1">&#39;replan&#39;</span>
    <span class="n">EXEC</span> <span class="o">=</span> <span class="s1">&#39;exec&#39;</span>
    <span class="n">RECOVER_CHECK</span> <span class="o">=</span> <span class="s1">&#39;recover-check&#39;</span>
    <span class="n">PERFORM_CHECK</span> <span class="o">=</span> <span class="s1">&#39;perform-check&#39;</span>


<span class="k">class</span> <span class="nc">ChangeStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum of Pebble Change statuses.&quot;&quot;&quot;</span>

    <span class="n">HOLD</span> <span class="o">=</span> <span class="s1">&#39;Hold&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hold status means the task should not run for the moment, perhaps as a</span>
<span class="sd">	consequence of an error on another task.&quot;&quot;&quot;</span>

    <span class="n">DO</span> <span class="o">=</span> <span class="s1">&#39;Do&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do status means the change or task is ready to start.&quot;&quot;&quot;</span>

    <span class="n">DOING</span> <span class="o">=</span> <span class="s1">&#39;Doing&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Doing status means the change or task is running or an attempt was made to run it.&quot;&quot;&quot;</span>

    <span class="n">DONE</span> <span class="o">=</span> <span class="s1">&#39;Done&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Done status means the change or task was accomplished successfully.&quot;&quot;&quot;</span>

    <span class="n">ABORT</span> <span class="o">=</span> <span class="s1">&#39;Abort&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abort status means the task should stop doing its activities and then undo.&quot;&quot;&quot;</span>

    <span class="n">UNDO</span> <span class="o">=</span> <span class="s1">&#39;Undo&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Undo status means the change or task should be undone, probably due to an error.&quot;&quot;&quot;</span>

    <span class="n">UNDOING</span> <span class="o">=</span> <span class="s1">&#39;Undoing&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;UndoingStatus means the change or task is being undone or an attempt was made to undo it.&quot;&quot;&quot;</span>

    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;Error&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error status means the change or task has errored out while running or being undone.&quot;&quot;&quot;</span>

    <span class="n">WAIT</span> <span class="o">=</span> <span class="s1">&#39;Wait&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait status means the task was accomplished successfully but some</span>
<span class="sd">	external event needs to happen before work can progress further.&quot;&quot;&quot;</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Notice</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Information about a single notice.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Server-generated unique ID for this notice.&quot;&quot;&quot;</span>

    <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;UID of the user who may view this notice (None means notice is public).&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NoticeType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of the notice.&quot;&quot;&quot;</span>

    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The notice key, a string that differentiates notices of this type.</span>

<span class="sd">    This is in the format ``example.com/path``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">first_occurred</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The first time one of these notices (type and key combination) occurs.&quot;&quot;&quot;</span>

    <span class="n">last_occurred</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The last time one of these notices occurred.&quot;&quot;&quot;</span>

    <span class="n">last_repeated</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The time this notice was last repeated.</span>

<span class="sd">    See Pebble&#39;s `Notices documentation &lt;https://github.com/canonical/pebble/#notices&gt;`_</span>
<span class="sd">    for an explanation of what &quot;repeated&quot; means.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">occurrences</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of times one of these notices has occurred.&quot;&quot;&quot;</span>

    <span class="n">last_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Additional data captured from the last occurrence of one of these notices.&quot;&quot;&quot;</span>

    <span class="n">repeat_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum time after one of these was last repeated before Pebble will repeat it again.&quot;&quot;&quot;</span>

    <span class="n">expire_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;How long since one of these last occurred until Pebble will drop the notice.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;_NoticeDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Notice&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new Notice object from dict parsed from JSON.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">notice_type</span> <span class="o">=</span> <span class="n">NoticeType</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">notice_type</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user-id&#39;</span><span class="p">),</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">notice_type</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
            <span class="n">first_occurred</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;first-occurred&#39;</span><span class="p">]),</span>
            <span class="n">last_occurred</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;last-occurred&#39;</span><span class="p">]),</span>
            <span class="n">last_repeated</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_rfc3339</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;last-repeated&#39;</span><span class="p">]),</span>
            <span class="n">occurrences</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">],</span>
            <span class="n">last_data</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last-data&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">repeat_after</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_duration</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;repeat-after&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;repeat-after&#39;</span> <span class="ow">in</span> <span class="n">d</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">expire_after</span><span class="o">=</span><span class="n">timeconv</span><span class="o">.</span><span class="n">parse_duration</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;expire-after&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;expire-after&#39;</span> <span class="ow">in</span> <span class="n">d</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ExecProcess</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a process started by :meth:`Client.exec`.</span>

<span class="sd">    To avoid deadlocks, most users should use :meth:`wait_output` instead of</span>
<span class="sd">    reading and writing the :attr:`stdin`, :attr:`stdout`, and :attr:`stderr`</span>
<span class="sd">    attributes directly. Alternatively, users can pass stdin/stdout/stderr to</span>
<span class="sd">    :meth:`Client.exec`.</span>

<span class="sd">    This class should not be instantiated directly, only via</span>
<span class="sd">    :meth:`Client.exec`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard input for the process.</span>

<span class="sd">    If the stdin argument was not passed to :meth:`Client.exec`, this is a</span>
<span class="sd">    writable file-like object the caller can use to stream input to the</span>
<span class="sd">    process. It is None if stdin was passed to :meth:`Client.exec`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard output from the process.</span>

<span class="sd">    If the stdout argument was not passed to :meth:`Client.exec`, this is a</span>
<span class="sd">    readable file-like object the caller can use to stream output from the</span>
<span class="sd">    process. It is None if stdout was passed to :meth:`Client.exec`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard error from the process.</span>

<span class="sd">    If the stderr argument was not passed to :meth:`Client.exec` and</span>
<span class="sd">    ``combine_stderr`` was False, this is a readable file-like object the</span>
<span class="sd">    caller can use to stream error output from the process. It is None if</span>
<span class="sd">    stderr was passed to :meth:`Client.exec` or ``combine_stderr`` was True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">client</span><span class="p">:</span> <span class="s1">&#39;Client&#39;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">control_ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">,</span>
        <span class="n">stdio_ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">,</span>
        <span class="n">stderr_ws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;_WebSocket&#39;</span><span class="p">],</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span>
        <span class="n">cancel_stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]],</span>
        <span class="n">cancel_reader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">threads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_ws</span> <span class="o">=</span> <span class="n">control_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdio_ws</span> <span class="o">=</span> <span class="n">stdio_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_ws</span> <span class="o">=</span> <span class="n">stderr_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_id</span> <span class="o">=</span> <span class="n">change_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_stdin</span> <span class="o">=</span> <span class="n">cancel_stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_reader</span> <span class="o">=</span> <span class="n">cancel_reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="n">threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waited</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waited</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;ExecProcess instance garbage collected without call to wait() or wait_output()&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the process to finish.</span>

<span class="sd">        If a timeout was specified to the :meth:`Client.exec` call, this waits</span>
<span class="sd">        at most that duration.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if there was an error starting or running the process.</span>
<span class="sd">            ExecError: if the process exits with a non-zero exit code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExecError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># A bit more than the command timeout to ensure that happens first</span>
            <span class="n">timeout</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">wait_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_change_id</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># If stdin reader thread is running, stop it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_stdin</span><span class="p">()</span>

        <span class="c1"># Wait for all threads to finish (e.g., message barrier sent)</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># If we opened a cancel_reader pipe, close the read side now (write</span>
        <span class="c1"># side was already closed by _cancel_stdin().</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cancel_reader</span><span class="p">)</span>

        <span class="c1"># Close websockets (shutdown doesn&#39;t send CLOSE message or wait for response).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_ws</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdio_ws</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_ws</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChangeError</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>

        <span class="n">exit_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit-code&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exit_code</span>

    <span class="k">def</span> <span class="nf">wait_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the process to finish and return tuple of (stdout, stderr).</span>

<span class="sd">        If a timeout was specified to the :meth:`Client.exec` call, this waits</span>
<span class="sd">        at most that duration. If combine_stderr was True, stdout will include</span>
<span class="sd">        the process&#39;s standard error, and stderr will be None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if there was an error starting or running the process.</span>
<span class="sd">            ExecError: if the process exits with a non-zero exit code.</span>
<span class="sd">            TypeError: if :meth:`Client.exec` was called with the ``stdout`` argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;can&#39;t use wait_output() when exec was called with the stdout argument; &quot;</span>
                <span class="s1">&#39;use wait() instead&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">_start_thread</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_start_thread</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">exit_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span>

        <span class="n">out_value</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">AnyStr</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">err_value</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">AnyStr</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span> <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExecError</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">out_value</span><span class="p">,</span> <span class="n">err_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">out_value</span><span class="p">,</span> <span class="n">err_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send the given signal to the running process.</span>

<span class="sd">        Args:</span>
<span class="sd">            sig: Name or number of signal to send, e.g., &quot;SIGHUP&quot;, 1, or</span>
<span class="sd">                signal.SIGHUP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">Signals</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;signal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sig</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_has_fileno</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the file-like object has a valid fileno() method.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Some types define a fileno method that raises io.UnsupportedOperation,</span>
        <span class="c1"># but just catching all exceptions here won&#39;t hurt.</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_reader_to_websocket</span><span class="p">(</span>
    <span class="n">reader</span><span class="p">:</span> <span class="s1">&#39;_WebsocketReader&#39;</span><span class="p">,</span>
    <span class="n">ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cancel_reader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bufsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read reader through to EOF and send each chunk read to the websocket.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cancel_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Wait for either a read to be ready or the caller to cancel stdin</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">cancel_reader</span><span class="p">,</span> <span class="n">reader</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">cancel_reader</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">break</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">send_binary</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;{&quot;command&quot;:&quot;end&quot;}&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore # Send &quot;end&quot; command as TEXT frame to signal EOF</span>


<span class="k">def</span> <span class="nf">_websocket_to_writer</span><span class="p">(</span><span class="n">ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="s1">&#39;_WebsocketWriter&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Receive messages from websocket (until end signal) and write to writer.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Garbage sent, try to keep going</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot decode I/O command (invalid JSON)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">!=</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="c1"># A command we don&#39;t recognize, keep going</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid I/O command </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Received &quot;end&quot; command (EOF signal), stop thread</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_WebsocketWriter</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A writable file-like object that sends what&#39;s written to it to a websocket.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span>

    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Denote this file-like object as writable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write chunk to the websocket.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;value to write must be bytes, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_binary</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send end-of-file message to websocket.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;{&quot;command&quot;:&quot;end&quot;}&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_WebsocketReader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A readable file-like object whose reads come from a websocket.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">:</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Denote this file-like object as readable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read up to n bytes from the websocket (or one message if n&lt;0).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof</span><span class="p">:</span>
            <span class="c1"># Calling read() multiple times after EOF should still return EOF</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># Garbage sent, try to keep going</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot decode I/O command (invalid JSON)&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">command</span> <span class="o">!=</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                    <span class="c1"># A command we don&#39;t recognize, keep going</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid I/O command </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Received &quot;end&quot; command, return EOF designator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">chunk</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">read1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An alias for read.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pebble API client.</span>

<span class="sd">    Defaults to using a Unix socket at socket_path (which must be specified</span>
<span class="sd">    unless a custom opener is provided).</span>

<span class="sd">    For methods that wait for changes, such as :meth:`start_services` and :meth:`replan_services`,</span>
<span class="sd">    if the change fails or times out, then a :class:`ChangeError` or :class:`TimeoutError` will be</span>
<span class="sd">    raised.</span>

<span class="sd">    All methods may raise exceptions when there are problems communicating with Pebble. Problems</span>
<span class="sd">    connecting to or transferring data with Pebble will raise a :class:`ConnectionError`. When an</span>
<span class="sd">    error occurs executing the request, such as trying to add an invalid layer or execute a command</span>
<span class="sd">    that does not exist, an :class:`APIError` is raised.</span>

<span class="sd">    The ``timeout`` parameter specifies a timeout in seconds for blocking operations like the</span>
<span class="sd">    connection attempt to Pebble; used by ``urllib.request.OpenerDirector.open``. It&#39;s not for</span>
<span class="sd">    methods like :meth:`start_services` and :meth:`replan_services` mentioned above, and it&#39;s not</span>
<span class="sd">    for the command execution timeout defined in method :meth:`Client.exec`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">opener</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">OpenerDirector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;http://localhost&#39;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">socket_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`socket_path` should be a string, not: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">opener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_opener</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span> <span class="o">=</span> <span class="n">socket_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="n">opener</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_default_opener</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">OpenerDirector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the default opener to use for requests (HTTP over Unix socket).&quot;&quot;&quot;</span>
        <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">OpenerDirector</span><span class="p">()</span>
        <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">_UnixSocketHandler</span><span class="p">(</span><span class="n">socket_path</span><span class="p">))</span>
        <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPDefaultErrorHandler</span><span class="p">())</span>
        <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPRedirectHandler</span><span class="p">())</span>
        <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPErrorProcessor</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">opener</span>

    <span class="c1"># we need to cast the return type depending on the request params</span>
    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a JSON request to the Pebble server with the given HTTP method and path.</span>

<span class="sd">        If query dict is provided, it is encoded and appended as a query string</span>
<span class="sd">        to the URL. If body dict is provided, it is serialied as JSON and used</span>
<span class="sd">        as the HTTP body (with Content-Type: &quot;application/json&quot;). The resulting</span>
<span class="sd">        body is decoded from JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_raw</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_content_type</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
        <span class="n">raw_resp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">raw_resp</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ensure_content_type</span><span class="p">(</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="s1">&#39;Literal[&quot;multipart/form-data&quot;, &quot;application/json&quot;]&#39;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse Content-Type header from headers and ensure it&#39;s equal to expected.</span>

<span class="sd">        Return a dict of any options in the header, e.g., {&#39;boundary&#39;: ...}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;expected Content-Type </span><span class="si">{</span><span class="n">expected</span><span class="si">!r}</span><span class="s1">, got </span><span class="si">{</span><span class="n">ctype</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">_request_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a request to the Pebble server; return the raw HTTPResponse object.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">?</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">doseq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>  <span class="c1"># noqa: S310</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="c1"># Will only happen on read error or if Pebble sends invalid JSON.</span>
                <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">raise</span> <span class="n">APIError</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Could not connect to Pebble: socket not found at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span><span class="si">!r}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;(container restarted?)&#39;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">get_system_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SystemInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get system info.&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/system-info&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SystemInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">:</span> <span class="n">WarningState</span> <span class="o">=</span> <span class="n">WarningState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="ne">Warning</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of warnings in given state (pending or all).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="n">select</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/warnings&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="ne">Warning</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">ack_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Acknowledge warnings up to given timestamp, return number acknowledged.&quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;okay&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/warnings&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_changes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">select</span><span class="p">:</span> <span class="n">ChangeState</span> <span class="o">=</span> <span class="n">ChangeState</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
        <span class="n">service</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Change</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of changes in given state, filter by service name if given.&quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="n">select</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">service</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;for&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/changes&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Change</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">get_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Change</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get single change by ID.&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/v1/changes/</span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Change</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">abort_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Change</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abort change with given ID.&quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;abort&#39;</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/v1/changes/</span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Change</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">autostart_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the startup-enabled services and wait (poll) for them to be started.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Seconds before autostart change is considered timed out (float). If</span>
<span class="sd">                timeout is 0, submit the action but don&#39;t wait; just return the change ID</span>
<span class="sd">                immediately.</span>
<span class="sd">            delay: Seconds before executing the autostart change (float).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChangeID of the autostart change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if one or more of the services didn&#39;t start, and ``timeout`` is non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services_action</span><span class="p">(</span><span class="s1">&#39;autostart&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replan_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replan by (re)starting changed and startup-enabled services and wait for them to start.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Seconds before replan change is considered timed out (float). If</span>
<span class="sd">                timeout is 0, submit the action but don&#39;t wait; just return the change</span>
<span class="sd">                ID immediately.</span>
<span class="sd">            delay: Seconds before executing the replan change (float).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChangeID of the replan change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if one or more of the services didn&#39;t stop/start, and ``timeout`` is</span>
<span class="sd">                non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services_action</span><span class="p">(</span><span class="s1">&#39;replan&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_services</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">services</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start services by name and wait (poll) for them to be started.</span>

<span class="sd">        Args:</span>
<span class="sd">            services: Non-empty list of services to start.</span>
<span class="sd">            timeout: Seconds before start change is considered timed out (float). If</span>
<span class="sd">                timeout is 0, submit the action but don&#39;t wait; just return the change</span>
<span class="sd">                ID immediately.</span>
<span class="sd">            delay: Seconds before executing the start change (float).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChangeID of the start change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if one or more of the services didn&#39;t stop/start, and ``timeout`` is</span>
<span class="sd">                non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services_action</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_services</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">services</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop services by name and wait (poll) for them to be started.</span>

<span class="sd">        Args:</span>
<span class="sd">            services: Non-empty list of services to stop.</span>
<span class="sd">            timeout: Seconds before stop change is considered timed out (float). If</span>
<span class="sd">                timeout is 0, submit the action but don&#39;t wait; just return the change</span>
<span class="sd">                ID immediately.</span>
<span class="sd">            delay: Seconds before executing the stop change (float).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChangeID of the stop change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if one or more of the services didn&#39;t stop/start and ``timeout`` is</span>
<span class="sd">                non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services_action</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart_services</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">services</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restart services by name and wait (poll) for them to be started.</span>

<span class="sd">        Args:</span>
<span class="sd">            services: Non-empty list of services to restart.</span>
<span class="sd">            timeout: Seconds before restart change is considered timed out (float). If</span>
<span class="sd">                timeout is 0, submit the action but don&#39;t wait; just return the change</span>
<span class="sd">                ID immediately.</span>
<span class="sd">            delay: Seconds before executing the restart change (float).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChangeID of the restart change.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ChangeError: if one or more of the services didn&#39;t stop/start and ``timeout`` is</span>
<span class="sd">                non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services_action</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_services_action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">services</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChangeID</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;services must be of type Iterable[str], not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">services</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">services</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;service names must be str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">services</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/services&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">change_id</span> <span class="o">=</span> <span class="n">ChangeID</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_change</span><span class="p">(</span><span class="n">change_id</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChangeError</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">change_id</span>

    <span class="k">def</span> <span class="nf">wait_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Change</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the given change to be ready.</span>

<span class="sd">        If the Pebble server supports the /v1/changes/{id}/wait API endpoint,</span>
<span class="sd">        use that to avoid polling, otherwise poll /v1/changes/{id} every delay</span>
<span class="sd">        seconds.</span>

<span class="sd">        Args:</span>
<span class="sd">            change_id: Change ID of change to wait for.</span>
<span class="sd">            timeout: Maximum time in seconds to wait for the change to be</span>
<span class="sd">                ready. It may be None, in which case wait_change never times out.</span>
<span class="sd">            delay: If polling, this is the delay in seconds between attempts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Change object being waited on.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TimeoutError: If the maximum timeout is reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_change_using_wait</span><span class="p">(</span><span class="n">change_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="c1"># Pebble server doesn&#39;t support wait endpoint, fall back to polling</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_change_using_polling</span><span class="p">(</span><span class="n">change_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_change_using_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a change to be ready using the wait-change API.&quot;&quot;&quot;</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Hit the wait endpoint every Client.timeout-1 seconds to avoid long</span>
        <span class="c1"># requests (the -1 is to ensure it wakes up before the socket timeout)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">this_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># minimum of 1 second</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time_remaining</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">time_remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># Wait the lesser of the time remaining and Client.timeout-1</span>
                <span class="n">this_timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">time_remaining</span><span class="p">,</span> <span class="n">this_timeout</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_change</span><span class="p">(</span><span class="n">change_id</span><span class="p">,</span> <span class="n">this_timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">builtins</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">):</span>
                <span class="c1"># NOTE: in Python 3.10 socket.timeout is an alias of TimeoutError,</span>
                <span class="c1"># but we still need to support Python 3.8, so catch both.</span>
                <span class="c1"># Catch timeout from wait endpoint and loop to check deadline.</span>
                <span class="k">pass</span>

        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;timed out waiting for change </span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s1"> seconds)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Change</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the wait-change API endpoint directly.&quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/v1/changes/</span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1">/wait&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;server does not implement wait-change endpoint&#39;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">504</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;timed out waiting for change </span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s1"> seconds)&#39;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">Change</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_wait_change_using_polling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">change_id</span><span class="p">:</span> <span class="n">ChangeID</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a change to be ready by polling the get-change API.&quot;&quot;&quot;</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
            <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_change</span><span class="p">(</span><span class="n">change_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">change</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;timed out waiting for change </span><span class="si">{</span><span class="n">change_id</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s1"> seconds)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_layer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;LayerDict&#39;</span><span class="p">,</span> <span class="n">Layer</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">combine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dynamically add a new layer onto the Pebble configuration layers.</span>

<span class="sd">        If combine is False (the default), append the new layer as the top</span>
<span class="sd">        layer with the given label. If combine is True and the label already</span>
<span class="sd">        exists, the two layers are combined into a single one considering the</span>
<span class="sd">        layer override rules; if the layer doesn&#39;t exist, it is added as usual.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;label must be a str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">layer_yaml</span> <span class="o">=</span> <span class="n">layer</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">layer_yaml</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">layer_yaml</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;layer must be str, dict, or pebble.Layer, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span>
            <span class="s1">&#39;combine&#39;</span><span class="p">:</span> <span class="n">combine</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="n">layer_yaml</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/layers&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Plan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the Pebble plan (contains combined layer configuration).&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/plan&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">Plan</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ServiceInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the service status for the configured services.</span>

<span class="sd">        If names is specified, only fetch the service status for the services</span>
<span class="sd">        named.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/services&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ServiceInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">pull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BinaryIO</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">pull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TextIO</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">pull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a file&#39;s content from the remote system.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path of the file to read from the remote system.</span>
<span class="sd">            encoding: Encoding to use for decoding the file&#39;s bytes to str,</span>
<span class="sd">                or None to specify no decoding.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A readable file-like object, whose read() method will return str</span>
<span class="sd">            objects decoded according to the specified encoding, or bytes if</span>
<span class="sd">            encoding is None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PathError: If there was an error reading the file at path, for</span>
<span class="sd">                example, if the file doesn&#39;t exist or is a directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_raw</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/files&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_content_type</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="s1">&#39;multipart/form-data&#39;</span><span class="p">)</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;boundary&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">boundary</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;invalid boundary </span><span class="si">{</span><span class="n">boundary</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">_FilesParser</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;no &quot;response&quot; field in multipart body&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_path_error</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">filenames</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">filenames</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;no file content in multipart response&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;single file request resulted in a multi-file response&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;path not expected: </span><span class="si">{</span><span class="n">filename</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">remove_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_raise_on_path_error</span><span class="p">(</span><span class="n">resp</span><span class="p">:</span> <span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># in case it&#39;s null instead of []</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;path not found in response metadata: </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PathError</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">],</span> <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="s1">&#39;_IOSource&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="n">make_dirs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write content to a given file path on the remote system.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path of the file to write to on the remote system.</span>
<span class="sd">            source: Source of data to write. This is either a concrete str or</span>
<span class="sd">                bytes instance, or a readable file-like object.</span>
<span class="sd">            encoding: Encoding to use for encoding source str to bytes, or</span>
<span class="sd">                strings read from source if it is a TextIO type. Ignored if</span>
<span class="sd">                source is bytes or BinaryIO.</span>
<span class="sd">            make_dirs: If True, create parent directories if they don&#39;t exist.</span>
<span class="sd">            permissions: Permissions (mode) to create file with (Pebble default</span>
<span class="sd">                is 0o644).</span>
<span class="sd">            user_id: User ID (UID) for file.</span>
<span class="sd">            user: Username for file. User&#39;s UID must match user_id if both are</span>
<span class="sd">                specified.</span>
<span class="sd">            group_id: Group ID (GID) for file.</span>
<span class="sd">            group: Group name for file. Group&#39;s GID must match group_id if</span>
<span class="sd">                both are specified.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PathError: If there was an error writing the file to the path; for example, if the</span>
<span class="sd">                destination path doesn&#39;t exist and ``make_dirs`` is not used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_auth_dict</span><span class="p">(</span><span class="n">permissions</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">make_dirs</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;make-dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;write&#39;</span><span class="p">,</span>
            <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">info</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_multipart</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_raw</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_content_type</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="c1"># we need to cast the Dict[Any, Any] to _FilesResponse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_path_error</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_auth_dict</span><span class="p">(</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_AuthDict&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="p">:</span> <span class="n">_AuthDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">permissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">permissions</span><span class="p">,</span> <span class="s1">&#39;03o&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;user-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;group-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_id</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_encode_multipart</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="s1">&#39;_IOSource&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="c1"># Python&#39;s stdlib mime/multipart handling is screwy and doesn&#39;t handle</span>
        <span class="c1"># binary properly, so roll our own.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">source_io</span><span class="p">:</span> <span class="n">_AnyStrFileLikeIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">source_io</span><span class="p">:</span> <span class="n">_AnyStrFileLikeIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_io</span><span class="p">:</span> <span class="n">_AnyStrFileLikeIO</span> <span class="o">=</span> <span class="n">source</span>  <span class="c1"># type: ignore</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">path_escaped</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;multipart/form-data; boundary=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">boundary</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="sa">b</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">boundary</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;Content-Type: application/json</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;Content-Disposition: form-data; name=&quot;request&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">boundary</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;Content-Type: application/octet-stream</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;Content-Disposition: form-data; name=&quot;files&quot;; filename=&quot;&#39;</span><span class="p">,</span>
                <span class="n">path_escaped</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">])</span>

            <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">content</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">source_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">)</span>

            <span class="k">yield</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">boundary</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;--</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="n">generator</span><span class="p">(),</span> <span class="n">content_type</span>

    <span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">itself</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of directory entries from given path on remote system.</span>

<span class="sd">        Despite the name, this method returns a list of files *and*</span>
<span class="sd">        directories, similar to :func:`os.listdir` or :func:`os.scandir`.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path of the directory to list, or path of the file to return</span>
<span class="sd">                information about.</span>
<span class="sd">            pattern: If specified, filter the list to just the files that match,</span>
<span class="sd">                for example ``*.txt``.</span>
<span class="sd">            itself: If path refers to a directory, return information about the</span>
<span class="sd">                directory itself, rather than its contents.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PathError: if there was an error listing the directory; for example, if the directory</span>
<span class="sd">                does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="k">if</span> <span class="n">itself</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;itself&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/files&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># in case it&#39;s null instead of []</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">FileInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">make_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a directory on the remote system with the given attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path of the directory to create on the remote system.</span>
<span class="sd">            make_parents: If True, create parent directories if they don&#39;t exist.</span>
<span class="sd">            permissions: Permissions (mode) to create directory with (Pebble</span>
<span class="sd">                default is 0o755).</span>
<span class="sd">            user_id: User ID (UID) for directory.</span>
<span class="sd">            user: Username for directory. User&#39;s UID must match user_id if</span>
<span class="sd">                both are specified.</span>
<span class="sd">            group_id: Group ID (GID) for directory.</span>
<span class="sd">            group: Group name for directory. Group&#39;s GID must match group_id</span>
<span class="sd">                if both are specified.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PathError: if there was an error making the directory; for example, if the parent path</span>
<span class="sd">                does not exist, and ``make_parents`` is not used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_auth_dict</span><span class="p">(</span><span class="n">permissions</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">make_parents</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;make-parents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;make-dirs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dirs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">info</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_path_error</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a file or directory on the remote system.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path of the file or directory to delete from the remote system.</span>
<span class="sd">            recursive: If True, and path is a directory, recursively delete it and</span>
<span class="sd">                       everything under it. If path is a file, delete the file. In</span>
<span class="sd">                       either case, do nothing if the file or directory does not</span>
<span class="sd">                       exist. Behaviourally similar to ``rm -rf &lt;file|dir&gt;``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            pebble.PathError: If a relative path is provided, or if `recursive` is False</span>
<span class="sd">                and the file or directory cannot be removed (it does not exist or is not empty).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;recursive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span>
            <span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">info</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_path_error</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># Exec I/O is str if encoding is provided (the default)</span>
    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">service_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="n">combine_stderr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecProcess</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span> <span class="o">...</span>

    <span class="c1"># Exec I/O is bytes if encoding is explicitly set to None</span>
    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">service_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">combine_stderr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecProcess</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">service_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TextIO</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TextIO</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="n">combine_stderr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecProcess</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Execute the given command on the remote system.</span>

<span class="sd">        Two method signatures are shown because this method returns an</span>
<span class="sd">        :class:`ExecProcess` that deals with strings if ``encoding`` is</span>
<span class="sd">        specified (the default ), or one that deals with bytes if ``encoding``</span>
<span class="sd">        is set to ``None``.</span>

<span class="sd">        Most of the parameters are explained in the &quot;Parameters&quot; section</span>
<span class="sd">        below, however, input/output handling is a bit more complex. Some</span>
<span class="sd">        examples are shown below::</span>

<span class="sd">            # Simple command with no output; just check exit code</span>
<span class="sd">            &gt;&gt;&gt; process = client.exec([&#39;send-emails&#39;])</span>
<span class="sd">            &gt;&gt;&gt; process.wait()</span>

<span class="sd">            # Fetch output as string</span>
<span class="sd">            &gt;&gt;&gt; process = client.exec([&#39;python3&#39;, &#39;--version&#39;])</span>
<span class="sd">            &gt;&gt;&gt; version, _ = process.wait_output()</span>
<span class="sd">            &gt;&gt;&gt; print(version)</span>
<span class="sd">            Python 3.8.10</span>

<span class="sd">            # Fetch both stdout and stderr as strings</span>
<span class="sd">            &gt;&gt;&gt; process = client.exec([&#39;pg_dump&#39;, &#39;-s&#39;, ...])</span>
<span class="sd">            &gt;&gt;&gt; schema, logs = process.wait_output()</span>

<span class="sd">            # Stream input from a string and write output to files</span>
<span class="sd">            &gt;&gt;&gt; stdin = &#39;foo\nbar\n&#39;</span>
<span class="sd">            &gt;&gt;&gt; with open(&#39;out.txt&#39;, &#39;w&#39;) as out, open(&#39;err.txt&#39;, &#39;w&#39;) as err:</span>
<span class="sd">            ...     process = client.exec([&#39;awk&#39;, &#39;{ print toupper($0) }&#39;],</span>
<span class="sd">            ...                           stdin=stdin, stdout=out, stderr=err)</span>
<span class="sd">            ...     process.wait()</span>
<span class="sd">            &gt;&gt;&gt; open(&#39;out.txt&#39;).read()</span>
<span class="sd">            &#39;FOO\nBAR\n&#39;</span>
<span class="sd">            &gt;&gt;&gt; open(&#39;err.txt&#39;).read()</span>
<span class="sd">            &#39;&#39;</span>

<span class="sd">            # Real-time streaming using ExecProcess.stdin and ExecProcess.stdout</span>
<span class="sd">            &gt;&gt;&gt; process = client.exec([&#39;cat&#39;])</span>
<span class="sd">            &gt;&gt;&gt; def stdin_thread():</span>
<span class="sd">            ...     for line in [&#39;one\n&#39;, &#39;2\n&#39;, &#39;THREE\n&#39;]:</span>
<span class="sd">            ...         process.stdin.write(line)</span>
<span class="sd">            ...         process.stdin.flush()</span>
<span class="sd">            ...         time.sleep(1)</span>
<span class="sd">            ...     process.stdin.close()</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; threading.Thread(target=stdin_thread).start()</span>
<span class="sd">            &gt;&gt;&gt; for line in process.stdout:</span>
<span class="sd">            ...     print(datetime.datetime.now().strftime(&#39;%H:%M:%S&#39;), repr(line))</span>
<span class="sd">            ...</span>
<span class="sd">            16:20:26 &#39;one\n&#39;</span>
<span class="sd">            16:20:27 &#39;2\n&#39;</span>
<span class="sd">            16:20:28 &#39;THREE\n&#39;</span>
<span class="sd">            &gt;&gt;&gt; process.wait()  # will return immediately as stdin was closed</span>

<span class="sd">            # Show exception raised for non-zero return code</span>
<span class="sd">            &gt;&gt;&gt; process = client.exec([&#39;ls&#39;, &#39;notexist&#39;])</span>
<span class="sd">            &gt;&gt;&gt; out, err = process.wait_output()</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">              ...</span>
<span class="sd">            ExecError: &quot;ls&quot; returned exit code 2</span>
<span class="sd">            &gt;&gt;&gt; exc = sys.last_value</span>
<span class="sd">            &gt;&gt;&gt; exc.exit_code</span>
<span class="sd">            2</span>
<span class="sd">            &gt;&gt;&gt; exc.stdout</span>
<span class="sd">            &#39;&#39;</span>
<span class="sd">            &gt;&gt;&gt; exc.stderr</span>
<span class="sd">            &quot;ls: cannot access &#39;notfound&#39;: No such file or directory\n&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            command: Command to execute: the first item is the name (or path)</span>
<span class="sd">                of the executable, the rest of the items are the arguments.</span>
<span class="sd">            service_context: If specified, run the command in the context of</span>
<span class="sd">                this service. Specifically, inherit its environment variables,</span>
<span class="sd">                user/group settings, and working directory. The other exec</span>
<span class="sd">                options will override the service context; ``environment``</span>
<span class="sd">                will be merged on top of the service&#39;s.</span>
<span class="sd">            environment: Environment variables to pass to the process.</span>
<span class="sd">            working_dir: Working directory to run the command in. If not set,</span>
<span class="sd">                Pebble uses the target user&#39;s $HOME directory (and if the user</span>
<span class="sd">                argument is not set, $HOME of the user Pebble is running as).</span>
<span class="sd">            timeout: Timeout in seconds for the command execution, after which</span>
<span class="sd">                the process will be terminated. If not specified, the</span>
<span class="sd">                execution never times out.</span>
<span class="sd">            user_id: User ID (UID) to run the process as.</span>
<span class="sd">            user: Username to run the process as. User&#39;s UID must match</span>
<span class="sd">                user_id if both are specified.</span>
<span class="sd">            group_id: Group ID (GID) to run the process as.</span>
<span class="sd">            group: Group name to run the process as. Group&#39;s GID must match</span>
<span class="sd">                group_id if both are specified.</span>
<span class="sd">            stdin: A string or readable file-like object that is sent to the</span>
<span class="sd">                process&#39;s standard input. If not set, the caller can write</span>
<span class="sd">                input to :attr:`ExecProcess.stdin` to stream input to the</span>
<span class="sd">                process.</span>
<span class="sd">            stdout: A writable file-like object that the process&#39;s standard</span>
<span class="sd">                output is written to. If not set, the caller can use</span>
<span class="sd">                :meth:`ExecProcess.wait_output` to capture output as a string,</span>
<span class="sd">                or read from :meth:`ExecProcess.stdout` to stream output from</span>
<span class="sd">                the process.</span>
<span class="sd">            stderr: A writable file-like object that the process&#39;s standard</span>
<span class="sd">                error is written to. If not set, the caller can use</span>
<span class="sd">                :meth:`ExecProcess.wait_output` to capture error output as a</span>
<span class="sd">                string, or read from :meth:`ExecProcess.stderr` to stream</span>
<span class="sd">                error output from the process. Must be None if combine_stderr</span>
<span class="sd">                is True.</span>
<span class="sd">            encoding: If encoding is set (the default is UTF-8), the types</span>
<span class="sd">                read or written to stdin/stdout/stderr are str, and encoding</span>
<span class="sd">                is used to encode them to bytes. If encoding is None, the</span>
<span class="sd">                types read or written are raw bytes.</span>
<span class="sd">            combine_stderr: If True, process&#39;s stderr output is combined into</span>
<span class="sd">                its stdout (the stderr argument must be None). If False,</span>
<span class="sd">                separate streams are used for stdout and stderr.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Process object representing the state of the running process.</span>
<span class="sd">            To wait for the command to finish, the caller will typically call</span>
<span class="sd">            :meth:`ExecProcess.wait` if stdout/stderr were provided as</span>
<span class="sd">            arguments to :meth:`exec`, or :meth:`ExecProcess.wait_output` if</span>
<span class="sd">            not.</span>

<span class="sd">        Raises:</span>
<span class="sd">            APIError: if an error occurred communicating with pebble, or if the command is not</span>
<span class="sd">                found.</span>
<span class="sd">            ExecError: if the command exits with a non-zero exit code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">command</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;command must be a list of str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;command must contain at least one item&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;encoding must be set if stdin is str&#39;</span><span class="p">)</span>
                <span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stdin</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;encoding must be None if stdin is bytes&#39;</span><span class="p">)</span>
                <span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;stdin must be str, bytes, or a readable file-like object&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">combine_stderr</span> <span class="ow">and</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;stderr must be None if combine_stderr is True&#39;</span><span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
            <span class="s1">&#39;service-context&#39;</span><span class="p">:</span> <span class="n">service_context</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">environment</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="s1">&#39;working-dir&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">_format_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;user-id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;group-id&#39;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span>
            <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
            <span class="s1">&#39;split-stderr&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">combine_stderr</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/exec&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">change_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;task-id&#39;</span><span class="p">]</span>

        <span class="n">stderr_ws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_WebSocket</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">control_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_websocket</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">)</span>
            <span class="n">stdio_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_websocket</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="s1">&#39;stdio&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">combine_stderr</span><span class="p">:</span>
                <span class="n">stderr_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_websocket</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">websocket</span><span class="o">.</span><span class="n">WebSocketException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Error connecting to websockets, probably due to the exec/change</span>
            <span class="c1"># finishing early with an error. Call wait_change to pick that up.</span>
            <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_change</span><span class="p">(</span><span class="n">ChangeID</span><span class="p">(</span><span class="n">change_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChangeError</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unexpected error connecting to websockets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">cancel_stdin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cancel_reader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">threads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_fileno</span><span class="p">(</span><span class="n">stdin</span><span class="p">):</span>
                <span class="c1"># Create a pipe so _reader_to_websocket can select() on the</span>
                <span class="c1"># reader as well as this cancel_reader; when we write anything</span>
                <span class="c1"># to cancel_writer it&#39;ll trigger the select and end the thread.</span>
                <span class="n">cancel_reader</span><span class="p">,</span> <span class="n">cancel_writer</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">_cancel_stdin</span><span class="p">():</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cancel_writer</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>  <span class="c1"># doesn&#39;t matter what we write</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">cancel_writer</span><span class="p">)</span>

                <span class="n">cancel_stdin</span> <span class="o">=</span> <span class="n">_cancel_stdin</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">_start_thread</span><span class="p">(</span><span class="n">_reader_to_websocket</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdio_ws</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">cancel_reader</span><span class="p">)</span>
            <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">process_stdin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process_stdin</span> <span class="o">=</span> <span class="n">_WebsocketWriter</span><span class="p">(</span><span class="n">stdio_ws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">process_stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">process_stdin</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">_start_thread</span><span class="p">(</span><span class="n">_websocket_to_writer</span><span class="p">,</span> <span class="n">stdio_ws</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">process_stdout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process_stdout</span> <span class="o">=</span> <span class="n">_WebsocketReader</span><span class="p">(</span><span class="n">stdio_ws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">process_stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">process_stdout</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="n">process_stderr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">combine_stderr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">_start_thread</span><span class="p">(</span><span class="n">_websocket_to_writer</span><span class="p">,</span> <span class="n">stderr_ws</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
                <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_WebSocket&#39;</span><span class="p">,</span> <span class="n">stderr_ws</span><span class="p">)</span>
                <span class="n">process_stderr</span> <span class="o">=</span> <span class="n">_WebsocketReader</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">process_stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                        <span class="n">process_stderr</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                        <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
                        <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">process</span><span class="p">:</span> <span class="n">ExecProcess</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExecProcess</span><span class="p">(</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">process_stdin</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">process_stdout</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">process_stderr</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">stdio_ws</span><span class="o">=</span><span class="n">stdio_ws</span><span class="p">,</span>
            <span class="n">stderr_ws</span><span class="o">=</span><span class="n">stderr_ws</span><span class="p">,</span>
            <span class="n">control_ws</span><span class="o">=</span><span class="n">control_ws</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">change_id</span><span class="o">=</span><span class="n">ChangeID</span><span class="p">(</span><span class="n">change_id</span><span class="p">),</span>
            <span class="n">cancel_stdin</span><span class="o">=</span><span class="n">cancel_stdin</span><span class="p">,</span>
            <span class="n">cancel_reader</span><span class="o">=</span><span class="n">cancel_reader</span><span class="p">,</span>
            <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">_connect_websocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">websocket_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_WebSocket&#39;</span><span class="p">:</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Set socket timeout to a short timeout during connection phase, in</span>
        <span class="c1"># case the Pebble side times out (5s), so this side doesn&#39;t hang. See:</span>
        <span class="c1"># https://github.com/canonical/operator/issues/1246</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_url</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">websocket_id</span><span class="p">)</span>
        <span class="n">ws</span><span class="p">:</span> <span class="n">_WebSocket</span> <span class="o">=</span> <span class="n">websocket</span><span class="o">.</span><span class="n">WebSocket</span><span class="p">(</span><span class="n">skip_utf8_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">socket</span><span class="o">=</span><span class="n">sock</span><span class="p">)</span>
        <span class="c1"># Reset to no timeout so connection can be &quot;long polling&quot; when data is</span>
        <span class="c1"># being received.</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ws</span>

    <span class="k">def</span> <span class="nf">_websocket_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">websocket_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;ws://&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s1">/v1/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/websocket/</span><span class="si">{</span><span class="n">websocket_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">services</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send the given signal to the list of services named.</span>

<span class="sd">        Args:</span>
<span class="sd">            sig: Name or number of signal to send, for example ``&quot;SIGHUP&quot;``, ``1``, or</span>
<span class="sd">                ``signal.SIGHUP``.</span>
<span class="sd">            services: Non-empty list of service names to send the signal to.</span>

<span class="sd">        Raises:</span>
<span class="sd">            APIError: If any of the services are not in the plan or are not</span>
<span class="sd">                currently running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;services must be of type Iterable[str], not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">services</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;service names must be str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">Signals</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">sig</span><span class="p">,</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">services</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/signals&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_checks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CheckLevel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the check status for the configured checks.</span>

<span class="sd">        Args:</span>
<span class="sd">            level: Optional check level to query for (default is to fetch</span>
<span class="sd">                checks with any level).</span>
<span class="sd">            names: Optional list of check names to query for (default is to</span>
<span class="sd">                fetch all checks).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of :class:`CheckInfo` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/checks&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">CheckInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">NoticeType</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repeat_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record an occurrence of a notice with the specified options.</span>

<span class="sd">        Args:</span>
<span class="sd">            type: Notice type (currently only &quot;custom&quot; notices are supported).</span>
<span class="sd">            key: Notice key; must be in &quot;example.com/path&quot; format.</span>
<span class="sd">            data: Data fields for this notice.</span>
<span class="sd">            repeat_after: Only allow this notice to repeat after this duration</span>
<span class="sd">                has elapsed (the default is to always repeat).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The notice&#39;s ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">repeat_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span><span class="p">[</span><span class="s1">&#39;repeat-after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_timeout</span><span class="p">(</span><span class="n">repeat_after</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/notices&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_notice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Notice</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get details about a single notice by ID.</span>

<span class="sd">        Raises:</span>
<span class="sd">            APIError: if a notice with the given ID is not found (``code`` 404)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/v1/notices/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Notice</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_notices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NoticesUsers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">NoticeType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Notice</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query for notices that match all of the provided filters.</span>

<span class="sd">        Pebble returns notices that match all of the filters, for example, if</span>
<span class="sd">        called with ``types=[NoticeType.CUSTOM], keys=[&quot;example.com/a&quot;]``,</span>
<span class="sd">        Pebble will only return custom notices that also have key &quot;example.com/a&quot;.</span>

<span class="sd">        If no filters are specified, return notices viewable by the requesting</span>
<span class="sd">        user (notices whose ``user_id`` matches the requester UID as well as</span>
<span class="sd">        public notices).</span>

<span class="sd">        Note that the &quot;after&quot; filter is not yet implemented, as it&#39;s not</span>
<span class="sd">        needed right now and it&#39;s hard to implement correctly with Python&#39;s</span>
<span class="sd">        datetime type, which only has microsecond precision (and Go&#39;s Time</span>
<span class="sd">        type has nanosecond precision).</span>

<span class="sd">        Args:</span>
<span class="sd">            users: Change which users&#39; notices to return (instead of returning</span>
<span class="sd">                notices for the current user).</span>
<span class="sd">            user_id: Filter for notices for the specified user, including</span>
<span class="sd">                public notices (only works for Pebble admins).</span>
<span class="sd">            types: Filter for notices with any of the specified types.</span>
<span class="sd">            keys: Filter for notices with any of the specified keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;user-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">NoticeType</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/v1/notices&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Notice</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">_FilesParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A limited purpose multi-part parser backed by files for memory efficiency.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_FilesResponse</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># externally managed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_part_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;files&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># externally managed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># externally managed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Tempfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Prepare the MIME multipart boundary line patterns.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundary</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">boundary</span> <span class="o">=</span> <span class="n">boundary</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># State vars, as we may enter the feed() function multiple times.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">_MultipartParser</span><span class="p">(</span>
            <span class="n">boundary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_body</span><span class="p">,</span> <span class="n">max_lookahead</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span>
        <span class="p">)</span>

        <span class="c1"># RFC 2046 says that the boundary string needs to be preceded by a CRLF.</span>
        <span class="c1"># Unfortunately, the request library&#39;s header parsing logic strips off one of</span>
        <span class="c1"># these, so we&#39;ll prime the parser buffer with that missing sequence.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">BytesFeedParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">content_disposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get_content_disposition</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">content_disposition</span> <span class="o">!=</span> <span class="s1">&#39;form-data&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unexpected content disposition: </span><span class="si">{</span><span class="n">content_disposition</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s1">&#39;content-disposition&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;files&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;multipart &quot;files&quot; part missing filename&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_tempfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unexpected name in content-disposition header: </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_part_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;Literal[&quot;response&quot;, &quot;files&quot;]&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_part_type</span> <span class="o">==</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;response end marker not found&#39;</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_part_type</span> <span class="o">==</span> <span class="s1">&#39;files&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># This is the final write.</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_open_tempfile</span><span class="p">()</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Not the end of file data yet. Don&#39;t open/close file for intermediate writes</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_open_tempfile</span><span class="p">()</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all temporary files on disk.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide more data to the running parser.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_tempfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span>  <span class="c1"># type: ignore # we have a custom protocol for it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_get_open_tempfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_filename</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;_FilesResponse&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the deserialized JSON object from the multipart &quot;response&quot; field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

    <span class="k">def</span> <span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of filenames from the &quot;files&quot; parts of the response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;_TextOrBinaryIO&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an open file object containing the data.&quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span> <span class="k">if</span> <span class="n">encoding</span> <span class="k">else</span> <span class="s1">&#39;rb&#39;</span>
        <span class="c1"># We&#39;re using text-based file I/O purely for file encoding purposes, not for</span>
        <span class="c1"># newline normalization.  newline=&#39;&#39; serves the line endings as-is.</span>
        <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">encoding</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">file_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>  <span class="c1"># noqa: SIM115</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># open() returns IO[Any]</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_TextOrBinaryIO&#39;</span><span class="p">,</span> <span class="n">file_io</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_MultipartParser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">marker</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">handle_header</span><span class="p">:</span> <span class="s1">&#39;_HeaderHandler&#39;</span><span class="p">,</span>
        <span class="n">handle_body</span><span class="p">:</span> <span class="s1">&#39;_BodyHandler&#39;</span><span class="p">,</span>
        <span class="n">max_lookahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_boundary_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Configures a parser for mime multipart messages.</span>

<span class="sd">        Args:</span>
<span class="sd">            marker: the multipart boundary marker (i.e. in &quot;\r\n--&lt;marker&gt;--\r\n&quot;)</span>

<span class="sd">            handle_header(data): called once with the entire contents of a part</span>
<span class="sd">            header as encountered in data fed to the parser</span>

<span class="sd">            handle_body(data, done=False): called incrementally as part body</span>
<span class="sd">            data is fed into the parser - its &quot;done&quot; parameter is set to true when</span>
<span class="sd">            the body is complete.</span>

<span class="sd">            max_lookahead: maximum amount of bytes to buffer when searching for a complete header.</span>

<span class="sd">            max_boundary_length: maximum number of bytes that can make up a part</span>
<span class="sd">            boundary (e.g. \r\n--&lt;marker&gt;--\r\n&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_marker</span> <span class="o">=</span> <span class="n">marker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_header</span> <span class="o">=</span> <span class="n">handle_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_body</span> <span class="o">=</span> <span class="n">handle_body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span> <span class="o">=</span> <span class="n">max_lookahead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_boundary_length</span> <span class="o">=</span> <span class="n">max_boundary_length</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># current position in buf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># whether we have found the terminal boundary and are done parsing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header_terminator</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span>

        <span class="c1"># RFC 2046 notes optional &quot;linear whitespace&quot; (e.g. [ \t]+) after the boundary pattern</span>
        <span class="c1"># and the optional &quot;--&quot; suffix.  The boundaries strings can be constructed as follows:</span>
        <span class="c1">#</span>
        <span class="c1">#     boundary = \r\n--&lt;marker&gt;[ \t]+\r\n</span>
        <span class="c1">#     terminal_boundary = \r\n--&lt;marker&gt;--[ \t]+\r\n</span>
        <span class="c1">#</span>
        <span class="c1"># 99 is arbitrarily chosen to represent a max number of linear</span>
        <span class="c1"># whitespace characters to help avoid wrongly writing boundary</span>
        <span class="c1"># characters into a (temporary) file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_boundary_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_boundary_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">--&#39;</span> <span class="o">+</span> <span class="n">marker</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;--</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">99</span>

    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Feeds data incrementally into the parser.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># seek to a boundary if we aren&#39;t already on one</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="n">_next_part_boundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marker</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># waiting for more data or terminal boundary reached</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># parse the part header</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_lookahead</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;header terminator not found&#39;</span><span class="p">)</span>
                <span class="n">term_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_terminator</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">term_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span>  <span class="c1"># waiting for more data</span>

                <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span>
                <span class="c1"># data includes the double CRLF at the end of the header.</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">term_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_terminator</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># parse the part body</span>
                <span class="n">ii</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="n">_next_part_boundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marker</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
                <span class="n">safe_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_boundary_length</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># part body is finished</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="p">:</span> <span class="n">ii</span><span class="p">],</span> <span class="n">done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">[</span><span class="n">ii</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
                        <span class="k">return</span>  <span class="c1"># terminal boundary reached</span>
                <span class="k">elif</span> <span class="n">safe_bound</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">:</span>
                    <span class="c1"># write partial body data</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="p">:</span> <span class="n">safe_bound</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">safe_bound</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_body</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># waiting for more data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>  <span class="c1"># waiting for more data</span>


<span class="k">def</span> <span class="nf">_next_part_boundary</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">marker</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the index of the next boundary marker in buf beginning at start.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (index, length, is_terminal) or (-1, -1, False) if no boundary is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">--&#39;</span> <span class="o">+</span> <span class="n">marker</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
    <span class="n">terminal_midfix</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;--&#39;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">is_terminal</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">terminal_midfix</span><span class="p">):</span>
        <span class="n">is_terminal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terminal_midfix</span><span class="p">)</span>

    <span class="c1"># Note: RFC 2046 notes optional &quot;linear whitespace&quot; (e.g. [ \t]) after the boundary pattern</span>
    <span class="c1"># and the optional &quot;--&quot; suffix.</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="sa">b</span><span class="s1">&#39; </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_terminal</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>
</pre></div>
        </article>
      </div>
      <footer>
        
   

<div class="related-pages">
  
  
  
  
</div>
<div class="bottom-of-page">
  <div class="left-details">
    <div class="copyright">
        Copyright &#169; 2024, Canonical Ltd.
    </div>

    <div class="last-updated">
      Last updated on Aug 29, 2024</div>
  </div>
  <div class="right-details">

    

    
    <div class="ask-discourse">
      <a class="muted-link" href="https://discourse.charmhub.io/">Ask a question on Discourse</a>
    </div>
    

    

    
    <div class="ask-matrix">
      <a class="muted-link" href="https://matrix.to/#/#charmhub-charmdev:ubuntu.com">Ask a question on Matrix</a>
    </div>
    

    

    
    <div class="issue-github">
      <a class="muted-link" href="https://github.com/canonical/ops-scenario/issues/new?title=doc%3A+ADD+A+TITLE&body=DESCRIBE+THE+ISSUE%0A%0A---%0ADocument: _modules/ops/pebble">Open a GitHub issue for this page</a>
    </div>
    

    <div class="edit-github">
      <a class="muted-link" href="https://github.com/canonical/ops-scenario/edit/main/docs/_modules/ops/pebble">Edit this page on GitHub</a>
    </div>
    


    </div>
  </div>
</div>

      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
<div class="toc-sticky toc-scroll">
   
    <div class="toc-title-container">
      <span class="toc-title">
       Contents
      </span>
    </div>
    <div class="toc-tree-container">
      <div class="toc-tree">
        
      </div>
    </div>
   
    
  </div>

    </aside>
  </div>
</div><script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/header-nav.js?v=e117ad08"></script>
    <script src="../../_static/github_issue_links.js?v=32bb732f"></script>
    
<script>
  const github_url = "https://github.com/canonical/ops-scenario";
</script>
</body>
</html>