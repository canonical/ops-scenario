<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/favicon.png"/><!-- Generated with Sphinx 6.2.1 and Furo 2024.01.29 -->
        <title>scenario.state - Scenario documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=369552022d0b975c8e74270ce6eabe0fb7978f24" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/youtube.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/related-links.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/terminal-output.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/header.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/github_issue_links.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/furo_colors.css" />
    
</head>
  <body>
    <header id="header" class="p-navigation">

  <div class="p-navigation__nav" role="menubar">

    <ul class="p-navigation__links" role="menu">

      <li>
        <a class="p-logo" href="https://juju.is/docs/sdk" aria-current="page">
          <img src="../../_static/tag.png" alt="Logo" class="p-logo-image">
          <div class="p-logo-text p-heading--4">Scenario
          </div>
        </a>
      </li>

      <li class="nav-ubuntu-com">
        <a href="https://juju.is/docs/sdk" class="p-navigation__link">juju.is/docs/sdk</a>
      </li>

      <li>
        <a href="#" class="p-navigation__link nav-more-links">More resources</a>
        <ul class="more-links-dropdown">

          <li>
            <a href="https://discourse.charmhub.io/" class="p-navigation__sub-link p-dropdown__link">Forum</a>
          </li>

          <li>
            <a href="https://github.com/canonical/ops-scenario" class="p-navigation__sub-link p-dropdown__link">GitHub</a>
          </li>

        </ul>
      </li>

    </ul>
  </div>
</header>
   
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Scenario documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Scenario documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
    <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
    <input type="submit" value="Go">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
  <div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for scenario.state</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright 2023 Canonical Ltd.</span>
<span class="c1"># See LICENSE file for licensing details.</span>

<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PurePosixPath</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Final</span><span class="p">,</span>
    <span class="n">FrozenSet</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">import</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">ops</span> <span class="kn">import</span> <span class="n">pebble</span>
<span class="kn">from</span> <span class="nn">ops.charm</span> <span class="kn">import</span> <span class="n">CharmBase</span><span class="p">,</span> <span class="n">CharmEvents</span>
<span class="kn">from</span> <span class="nn">ops.model</span> <span class="kn">import</span> <span class="n">CloudCredential</span> <span class="k">as</span> <span class="n">CloudCredential_Ops</span>
<span class="kn">from</span> <span class="nn">ops.model</span> <span class="kn">import</span> <span class="n">CloudSpec</span> <span class="k">as</span> <span class="n">CloudSpec_Ops</span>
<span class="kn">from</span> <span class="nn">ops.model</span> <span class="kn">import</span> <span class="n">SecretRotate</span><span class="p">,</span> <span class="n">StatusBase</span>

<span class="kn">from</span> <span class="nn">scenario.logger</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">scenario_logger</span>

<span class="n">JujuLogLine</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;JujuLogLine&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">scenario</span> <span class="kn">import</span> <span class="n">Context</span>

<span class="n">PathLike</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span>
<span class="n">AnyRelation</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Relation&quot;</span><span class="p">,</span> <span class="s2">&quot;PeerRelation&quot;</span><span class="p">,</span> <span class="s2">&quot;SubordinateRelation&quot;</span><span class="p">]</span>
<span class="n">AnyJson</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>
<span class="n">RawSecretRevisionContents</span> <span class="o">=</span> <span class="n">RawDataBagContents</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">UnitID</span> <span class="o">=</span> <span class="nb">int</span>

<span class="n">CharmType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;CharmType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">CharmBase</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">scenario_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

<span class="n">ATTACH_ALL_STORAGES</span> <span class="o">=</span> <span class="s2">&quot;ATTACH_ALL_STORAGES&quot;</span>
<span class="n">CREATE_ALL_RELATIONS</span> <span class="o">=</span> <span class="s2">&quot;CREATE_ALL_RELATIONS&quot;</span>
<span class="n">BREAK_ALL_RELATIONS</span> <span class="o">=</span> <span class="s2">&quot;BREAK_ALL_RELATIONS&quot;</span>
<span class="n">DETACH_ALL_STORAGES</span> <span class="o">=</span> <span class="s2">&quot;DETACH_ALL_STORAGES&quot;</span>

<span class="n">ACTION_EVENT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;_action&quot;</span>
<span class="c1"># all builtin events except secret events. They&#39;re special because they carry secret metadata.</span>
<span class="n">BUILTIN_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;start&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;install&quot;</span><span class="p">,</span>
    <span class="s2">&quot;install&quot;</span><span class="p">,</span>
    <span class="s2">&quot;start&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;remove&quot;</span><span class="p">,</span>
    <span class="s2">&quot;update_status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;config_changed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;upgrade_charm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pre_series_upgrade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;post_series_upgrade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;leader_elected&quot;</span><span class="p">,</span>
    <span class="s2">&quot;leader_settings_changed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collect_metrics&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">FRAMEWORK_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;pre_commit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;commit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collect_app_status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collect_unit_status&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">PEBBLE_READY_EVENT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;_pebble_ready&quot;</span>
<span class="n">PEBBLE_CUSTOM_NOTICE_EVENT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;_pebble_custom_notice&quot;</span>
<span class="n">PEBBLE_CHECK_FAILED_EVENT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;_pebble_check_failed&quot;</span>
<span class="n">PEBBLE_CHECK_RECOVERED_EVENT_SUFFIX</span> <span class="o">=</span> <span class="s2">&quot;_pebble_check_recovered&quot;</span>
<span class="n">RELATION_EVENTS_SUFFIX</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;_relation_changed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_relation_broken&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_relation_joined&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_relation_departed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_relation_created&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">STORAGE_EVENTS_SUFFIX</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;_storage_detaching&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_storage_attached&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SECRET_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;secret_changed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;secret_removed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;secret_rotate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;secret_expired&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">META_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CREATE_ALL_RELATIONS&quot;</span><span class="p">:</span> <span class="s2">&quot;_relation_created&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BREAK_ALL_RELATIONS&quot;</span><span class="p">:</span> <span class="s2">&quot;_relation_broken&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DETACH_ALL_STORAGES&quot;</span><span class="p">:</span> <span class="s2">&quot;_storage_detaching&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ATTACH_ALL_STORAGES&quot;</span><span class="p">:</span> <span class="s2">&quot;_storage_attached&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="StateValidationError"><a class="viewcode-back" href="../../index.html#scenario.state.StateValidationError">[docs]</a><span class="k">class</span> <span class="nc">StateValidationError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when individual parts of the State are inconsistent.&quot;&quot;&quot;</span></div>

    <span class="c1"># as opposed to InconsistentScenario error where the</span>
    <span class="c1"># **combination** of several parts of the State are.</span>


<div class="viewcode-block" id="MetadataNotFoundError"><a class="viewcode-back" href="../../index.html#scenario.state.MetadataNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">MetadataNotFoundError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when Scenario can&#39;t find a metadata.yaml file in the provided charm root.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ActionFailed"><a class="viewcode-back" href="../../index.html#scenario.state.ActionFailed">[docs]</a><span class="k">class</span> <span class="nc">ActionFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised at the end of the hook if the charm has called `event.fail()`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;State&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></div>


<span class="c1"># This can be replaced with the KW_ONLY dataclasses functionality in Python 3.10+.</span>
<span class="k">def</span> <span class="nf">_max_posargs</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">_MaxPositionalArgs</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raises TypeError when instantiating objects if arguments are not passed as keywords.</span>

<span class="sd">        Looks for a `_max_positional_args` class attribute, which should be an int</span>
<span class="sd">        indicating the maximum number of positional arguments that can be passed to</span>
<span class="sd">        `__init__` (excluding `self`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_max_positional_args</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># inspect.signature guarantees the order of parameters is as</span>
            <span class="c1"># declared, which aligns with dataclasses. Simpler ways of</span>
            <span class="c1"># getting the arguments (like __annotations__) do not have that</span>
            <span class="c1"># guarantee, although in practice it is the case.</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
            <span class="n">required_args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span>
            <span class="p">]</span>
            <span class="n">n_posargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">max_n_posargs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_max_positional_args</span>
            <span class="n">kw_only</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parameters</span><span class="p">)[</span><span class="n">max_n_posargs</span><span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">n_posargs</span> <span class="o">&gt;</span> <span class="n">max_n_posargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> takes </span><span class="si">{</span><span class="n">max_n_posargs</span><span class="si">}</span><span class="s2"> positional &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;argument</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">max_n_posargs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="si">}</span><span class="s2"> but &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_posargs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;was&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n_posargs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;were&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;given. The following arguments are keyword-only: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kw_only</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="c1"># Also check if there are just not enough arguments at all, because</span>
            <span class="c1"># the default TypeError message will incorrectly describe some of</span>
            <span class="c1"># the arguments as positional.</span>
            <span class="k">elif</span> <span class="n">n_posargs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_args</span><span class="p">):</span>
                <span class="n">required_pos</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">[</span><span class="n">n_posargs</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw_only</span>
                <span class="p">]</span>
                <span class="n">required_kw</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">[</span><span class="n">n_posargs</span><span class="p">:]</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kw_only</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">required_pos</span> <span class="ow">and</span> <span class="n">required_kw</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;positional: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_pos</span><span class="p">)</span><span class="si">}</span><span class="s2"> and keyword: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_kw</span><span class="p">)</span><span class="si">}</span><span class="s2"> arguments&quot;</span>
                <span class="k">elif</span> <span class="n">required_pos</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;positional argument</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">required_pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_pos</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;keyword argument</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">required_kw</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_kw</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> missing required </span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># The default __reduce__ doesn&#39;t understand that some arguments have</span>
            <span class="c1"># to be passed as keywords, so using the copy module fails.</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">),</span> <span class="p">())</span>

    <span class="k">return</span> <span class="n">_MaxPositionalArgs</span>


<div class="viewcode-block" id="CloudCredential"><a class="viewcode-back" href="../../index.html#scenario.state.CloudCredential">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CloudCredential</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
    <span class="n">auth_type</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authentication type.&quot;&quot;&quot;</span>

    <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dictionary containing cloud credentials.</span>
<span class="sd">    For example, for AWS, it contains `access-key` and `secret-key`;</span>
<span class="sd">    for Azure, `application-id`, `application-password` and `subscription-id`</span>
<span class="sd">    can be found here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">redacted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A list of redacted generic cloud API secrets.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_to_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudCredential_Ops</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CloudCredential_Ops</span><span class="p">(</span>
            <span class="n">auth_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
            <span class="n">redacted</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redacted</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CloudSpec"><a class="viewcode-back" href="../../index.html#scenario.state.CloudSpec">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CloudSpec</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of the cloud.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Juju cloud name.&quot;&quot;&quot;</span>

    <span class="n">region</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Region of the cloud.&quot;&quot;&quot;</span>

    <span class="n">endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint of the cloud.&quot;&quot;&quot;</span>

    <span class="n">identity_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity endpoint of the cloud.&quot;&quot;&quot;</span>

    <span class="n">storage_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storage endpoint of the cloud.&quot;&quot;&quot;</span>

    <span class="n">credential</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CloudCredential</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cloud credentials with key-value attributes.&quot;&quot;&quot;</span>

    <span class="n">ca_certificates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A list of CA certificates.&quot;&quot;&quot;</span>

    <span class="n">skip_tls_verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether to skip TLS verfication.&quot;&quot;&quot;</span>

    <span class="n">is_controller_cloud</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is the cloud used by the controller.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_to_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudSpec_Ops</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CloudSpec_Ops</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
            <span class="n">identity_endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_endpoint</span><span class="p">,</span>
            <span class="n">storage_endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_endpoint</span><span class="p">,</span>
            <span class="n">credential</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">credential</span><span class="o">.</span><span class="n">_to_ops</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">credential</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ca_certificates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certificates</span><span class="p">,</span>
            <span class="n">skip_tls_verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_tls_verify</span><span class="p">,</span>
            <span class="n">is_controller_cloud</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_controller_cloud</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Secret"><a class="viewcode-back" href="../../index.html#scenario.state.Secret">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Secret</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="c1"># mapping from revision IDs to each revision&#39;s contents</span>
    <span class="n">contents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;RawSecretRevisionContents&quot;</span><span class="p">]</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># CAUTION: ops-created Secrets (via .add_secret()) will have a canonicalized</span>
    <span class="c1">#  secret id (`secret:` prefix)</span>
    <span class="c1">#  but user-created ones will not. Using post-init to patch it in feels bad, but requiring the user to</span>
    <span class="c1">#  add the prefix manually every time seems painful as well.</span>

    <span class="c1"># indicates if the secret is owned by THIS unit, THIS app or some other app/unit.</span>
    <span class="c1"># if None, the implication is that the secret has been granted to this unit.</span>
    <span class="n">owner</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># what revision is currently tracked by this charm. Only meaningful if owner=False</span>
    <span class="n">revision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># mapping from relation IDs to remote unit/apps to which this secret has been granted.</span>
    <span class="c1"># Only applicable if owner</span>
    <span class="n">remote_grants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">expire</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rotate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretRotate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a new tracked revision.&quot;&quot;&quot;</span>
        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;revision&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;RawSecretRevisionContents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">expire</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rotate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretRotate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the metadata.&quot;&quot;&quot;</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">revision</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

        <span class="c1"># bypass frozen dataclass</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expire</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expire</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">expire</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;expire&quot;</span><span class="p">,</span> <span class="n">expire</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rotate&quot;</span><span class="p">,</span> <span class="n">rotate</span><span class="p">)</span></div>


<div class="viewcode-block" id="normalize_name"><a class="viewcode-back" href="../../index.html#scenario.state.normalize_name">[docs]</a><span class="k">def</span> <span class="nf">normalize_name</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Event names, in Scenario, uniformly use underscores instead of dashes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Address"><a class="viewcode-back" href="../../index.html#scenario.state.Address">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An address in a Juju network space.&quot;&quot;&quot;</span>

    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A host name that maps to the address in :attr:`value`.&quot;&quot;&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The IP address in the space.&quot;&quot;&quot;</span>
    <span class="n">cidr</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The CIDR of the address in :attr:`value`.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A deprecated alias for :attr:`value`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@address</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="BindAddress"><a class="viewcode-back" href="../../index.html#scenario.state.BindAddress">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BindAddress</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An address bound to a network interface in a Juju space.&quot;&quot;&quot;</span>

    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span>
    <span class="n">interface_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">mac_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BindAddress.hook_tool_output_fmt"><a class="viewcode-back" href="../../index.html#scenario.state.BindAddress.hook_tool_output_fmt">[docs]</a>    <span class="k">def</span> <span class="nf">hook_tool_output_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># dumps itself to dict in the same format the hook tool would</span>
        <span class="c1"># todo support for legacy (deprecated) `interfacename` and `macaddress` fields?</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;interface-name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_name</span><span class="p">,</span>
            <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addresses</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_address</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;mac-address&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_address</span>
        <span class="k">return</span> <span class="n">dct</span></div></div>


<div class="viewcode-block" id="Network"><a class="viewcode-back" href="../../index.html#scenario.state.Network">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Network</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">binding_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bind_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BindAddress</span><span class="p">]</span>
    <span class="n">ingress_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">egress_subnets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding_name</span><span class="p">)</span>

<div class="viewcode-block" id="Network.hook_tool_output_fmt"><a class="viewcode-back" href="../../index.html#scenario.state.Network.hook_tool_output_fmt">[docs]</a>    <span class="k">def</span> <span class="nf">hook_tool_output_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># dumps itself to dict in the same format the hook tool would</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;bind-addresses&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ba</span><span class="o">.</span><span class="n">hook_tool_output_fmt</span><span class="p">()</span> <span class="k">for</span> <span class="n">ba</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addresses</span><span class="p">],</span>
            <span class="s2">&quot;egress-subnets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">egress_subnets</span><span class="p">,</span>
            <span class="s2">&quot;ingress-addresses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ingress_addresses</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Network.default"><a class="viewcode-back" href="../../index.html#scenario.state.Network.default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">binding_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">private_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;192.0.2.0&quot;</span><span class="p">,</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">cidr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">interface_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">mac_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">egress_subnets</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;192.0.2.0/24&quot;</span><span class="p">,),</span>
        <span class="n">ingress_addresses</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;192.0.2.0&quot;</span><span class="p">,),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Network&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to create a minimal, heavily defaulted Network.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">binding_name</span><span class="o">=</span><span class="n">binding_name</span><span class="p">,</span>
            <span class="n">bind_addresses</span><span class="o">=</span><span class="p">[</span>
                <span class="n">BindAddress</span><span class="p">(</span>
                    <span class="n">interface_name</span><span class="o">=</span><span class="n">interface_name</span><span class="p">,</span>
                    <span class="n">mac_address</span><span class="o">=</span><span class="n">mac_address</span><span class="p">,</span>
                    <span class="n">addresses</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">Address</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">private_address</span><span class="p">,</span> <span class="n">cidr</span><span class="o">=</span><span class="n">cidr</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">egress_subnets</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">egress_subnets</span><span class="p">),</span>
            <span class="n">ingress_addresses</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ingress_addresses</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<span class="n">_next_relation_id_counter</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="next_relation_id"><a class="viewcode-back" href="../../index.html#scenario.state.next_relation_id">[docs]</a><span class="k">def</span> <span class="nf">next_relation_id</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_next_relation_id_counter</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">_next_relation_id_counter</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">_next_relation_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cur</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_RelationBase</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relation endpoint name. Must match some endpoint name defined in metadata.yaml.&quot;&quot;&quot;</span>

    <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface name. Must match the interface name attached to this endpoint in metadata.yaml.</span>
<span class="sd">    If left empty, it will be automatically derived from metadata.yaml.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">next_relation_id</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Juju relation ID. Every new Relation instance gets a unique one,</span>
<span class="sd">    if there&#39;s trouble, override.&quot;&quot;&quot;</span>

    <span class="n">local_app_data</span><span class="p">:</span> <span class="s2">&quot;RawDataBagContents&quot;</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This application&#39;s databag for this relation.&quot;&quot;&quot;</span>

    <span class="n">local_unit_data</span><span class="p">:</span> <span class="s2">&quot;RawDataBagContents&quot;</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">DEFAULT_JUJU_DATABAG</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This unit&#39;s databag for this relation.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_databags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield all databags in this relation.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_app_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_unit_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_remote_unit_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;UnitID&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ids of the units on the other end of this relation.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_databag_for_remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unit_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>  <span class="c1"># noqa: U100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the databag for some remote unit ID.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">_RelationBase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;_RelationBase cannot be instantiated directly; &quot;</span>
                <span class="s2">&quot;please use Relation, PeerRelation, or SubordinateRelation&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">databag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_databag</span><span class="p">(</span><span class="n">databag</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_databag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databag</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">databag</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StateValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;all databags should be dicts, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">databag</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">databag</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">StateValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;all databags should be Dict[str,str]; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;found a value of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>


<span class="n">_DEFAULT_IP</span> <span class="o">=</span> <span class="s2">&quot; 192.0.2.0&quot;</span>
<span class="n">DEFAULT_JUJU_DATABAG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;egress-subnets&quot;</span><span class="p">:</span> <span class="n">_DEFAULT_IP</span><span class="p">,</span>
    <span class="s2">&quot;ingress-address&quot;</span><span class="p">:</span> <span class="n">_DEFAULT_IP</span><span class="p">,</span>
    <span class="s2">&quot;private-address&quot;</span><span class="p">:</span> <span class="n">_DEFAULT_IP</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="Relation"><a class="viewcode-back" href="../../index.html#scenario.state.Relation">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Relation</span><span class="p">(</span><span class="n">_RelationBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An integration between the charm and another application.&quot;&quot;&quot;</span>

    <span class="n">remote_app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;remote&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the remote application, as in the charm&#39;s metadata.&quot;&quot;&quot;</span>

    <span class="c1"># local limit</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The maximum number of integrations on this endpoint.&quot;&quot;&quot;</span>

    <span class="n">remote_app_data</span><span class="p">:</span> <span class="s2">&quot;RawDataBagContents&quot;</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The current content of the application databag.&quot;&quot;&quot;</span>
    <span class="n">remote_units_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;UnitID&quot;</span><span class="p">,</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">DEFAULT_JUJU_DATABAG</span><span class="o">.</span><span class="n">copy</span><span class="p">()},</span>  <span class="c1"># dedup</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The current content of the databag for each unit in the relation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_remote_app_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Who is on the other end of this relation?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_app_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_remote_unit_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;UnitID&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ids of the units on the other end of this relation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_units_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_databag_for_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_id</span><span class="p">:</span> <span class="s2">&quot;UnitID&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the databag for some remote unit ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_units_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_databags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield all databags in this relation.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_app_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_unit_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_app_data</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_units_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>


<div class="viewcode-block" id="SubordinateRelation"><a class="viewcode-back" href="../../index.html#scenario.state.SubordinateRelation">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SubordinateRelation</span><span class="p">(</span><span class="n">_RelationBase</span><span class="p">):</span>
    <span class="n">remote_app_data</span><span class="p">:</span> <span class="s2">&quot;RawDataBagContents&quot;</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">remote_unit_data</span><span class="p">:</span> <span class="s2">&quot;RawDataBagContents&quot;</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">DEFAULT_JUJU_DATABAG</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># app name and ID of the remote unit that *this unit* is attached to.</span>
    <span class="n">remote_app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;remote&quot;</span>
    <span class="n">remote_unit_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_remote_unit_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ids of the units on the other end of this relation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_id</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_get_databag_for_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the databag for some remote unit ID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unit_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;invalid unit id (</span><span class="si">{</span><span class="n">unit_id</span><span class="si">}</span><span class="s2">): subordinate relation only has one &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;remote and that has id </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_databags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield all databags in this relation.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_app_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_unit_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_app_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remote_unit_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_app_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_unit_id</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="PeerRelation"><a class="viewcode-back" href="../../index.html#scenario.state.PeerRelation">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PeerRelation</span><span class="p">(</span><span class="n">_RelationBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A relation to share data between units of the charm.&quot;&quot;&quot;</span>

    <span class="n">peers_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;UnitID&quot;</span><span class="p">,</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">DEFAULT_JUJU_DATABAG</span><span class="o">.</span><span class="n">copy</span><span class="p">()},</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Current contents of the peer databags.&quot;&quot;&quot;</span>
    <span class="c1"># Consistency checks will validate that *this unit*&#39;s ID is not in here.</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_databags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield all databags in this relation.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_app_data</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_unit_data</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">peers_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_remote_unit_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;UnitID&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ids of the units on the other end of this relation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peers_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_databag_for_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_id</span><span class="p">:</span> <span class="s2">&quot;UnitID&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RawDataBagContents&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the databag for some remote unit ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">peers_data</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_random_model_name</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">string</span>

    <span class="n">space</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../index.html#scenario.state.Model">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Juju model in which the charm is deployed.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">_random_model_name</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the model.&quot;&quot;&quot;</span>
    <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A unique identifier for the model, typically generated by Juju.&quot;&quot;&quot;</span>

    <span class="c1"># whatever juju models --format=json | jq &#39;.models[&lt;current-model-index&gt;].type&#39; gives back.</span>
    <span class="c1"># TODO: make this exhaustive.</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span> <span class="s2">&quot;lxd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kubernetes&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The type of Juju model.&quot;&quot;&quot;</span>

    <span class="n">cloud_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CloudSpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cloud specification information (metadata) including credentials.&quot;&quot;&quot;</span></div>


<span class="c1"># for now, proc mock allows you to map one command to one mocked output.</span>
<span class="c1"># todo extend: one input -&gt; multiple outputs, at different times</span>


<span class="n">_CHANGE_IDS</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_generate_new_change_id</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_CHANGE_IDS</span>
    <span class="n">_CHANGE_IDS</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;change ID unset; automatically assigning </span><span class="si">{</span><span class="n">_CHANGE_IDS</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;If there are problems, pass one manually.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">_CHANGE_IDS</span>


<div class="viewcode-block" id="ExecOutput"><a class="viewcode-back" href="../../index.html#scenario.state.ExecOutput">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ExecOutput</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock data for simulated :meth:`ops.Container.exec` calls.&quot;&quot;&quot;</span>

    <span class="n">return_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The return code of the process (0 is success).&quot;&quot;&quot;</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any content written to stdout by the process.&quot;&quot;&quot;</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any content written to stderr by the process.&quot;&quot;&quot;</span>

    <span class="c1"># change ID: used internally to keep track of mocked processes</span>
    <span class="n">_change_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">_generate_new_change_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_id</span></div>


<span class="n">_ExecMock</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">ExecOutput</span><span class="p">]</span>


<div class="viewcode-block" id="Mount"><a class="viewcode-back" href="../../index.html#scenario.state.Mount">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Mount</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps local files to a :class:`Container` filesystem.&quot;&quot;&quot;</span>

    <span class="n">location</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PurePosixPath</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The location inside of the container.&quot;&quot;&quot;</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The content to provide when the charm does :meth:`ops.Container.pull`.&quot;&quot;&quot;</span></div>


<span class="k">def</span> <span class="nf">_now_utc</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


<span class="n">_next_notice_id_counter</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="next_notice_id"><a class="viewcode-back" href="../../index.html#scenario.state.next_notice_id">[docs]</a><span class="k">def</span> <span class="nf">next_notice_id</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_next_notice_id_counter</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">_next_notice_id_counter</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">_next_notice_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></div>


<div class="viewcode-block" id="Notice"><a class="viewcode-back" href="../../index.html#scenario.state.Notice">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Notice</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The notice key, a string that differentiates notices of this type.</span>

<span class="sd">    This is in the format ``domain/path``; for example:</span>
<span class="sd">    ``canonical.com/postgresql/backup`` or ``example.com/mycharm/notice``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">next_notice_id</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unique ID for this notice.&quot;&quot;&quot;</span>

    <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;UID of the user who may view this notice (None means notice is public).&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pebble</span><span class="o">.</span><span class="n">NoticeType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">NoticeType</span><span class="o">.</span><span class="n">CUSTOM</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of the notice.&quot;&quot;&quot;</span>

    <span class="n">first_occurred</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">_now_utc</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The first time one of these notices (type and key combination) occurs.&quot;&quot;&quot;</span>

    <span class="n">last_occurred</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">_now_utc</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The last time one of these notices occurred.&quot;&quot;&quot;</span>

    <span class="n">last_repeated</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">_now_utc</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The time this notice was last repeated.</span>

<span class="sd">    See Pebble&#39;s `Notices documentation &lt;https://github.com/canonical/pebble/#notices&gt;`_</span>
<span class="sd">    for an explanation of what &quot;repeated&quot; means.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">occurrences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of times one of these notices has occurred.&quot;&quot;&quot;</span>

    <span class="n">last_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Additional data captured from the last occurrence of one of these notices.&quot;&quot;&quot;</span>

    <span class="n">repeat_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum time after one of these was last repeated before Pebble will repeat it again.&quot;&quot;&quot;</span>

    <span class="n">expire_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;How long since one of these last occurred until Pebble will drop the notice.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_to_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pebble</span><span class="o">.</span><span class="n">Notice</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pebble</span><span class="o">.</span><span class="n">Notice</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">first_occurred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_occurred</span><span class="p">,</span>
            <span class="n">last_occurred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_occurred</span><span class="p">,</span>
            <span class="n">last_repeated</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_repeated</span><span class="p">,</span>
            <span class="n">occurrences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span><span class="p">,</span>
            <span class="n">last_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_data</span><span class="p">,</span>
            <span class="n">repeat_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat_after</span><span class="p">,</span>
            <span class="n">expire_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expire_after</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CheckInfo"><a class="viewcode-back" href="../../index.html#scenario.state.CheckInfo">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CheckInfo</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the check.&quot;&quot;&quot;</span>

    <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pebble</span><span class="o">.</span><span class="n">CheckLevel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Level of the check.&quot;&quot;&quot;</span>

    <span class="n">status</span><span class="p">:</span> <span class="n">pebble</span><span class="o">.</span><span class="n">CheckStatus</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">CheckStatus</span><span class="o">.</span><span class="n">UP</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status of the check.</span>

<span class="sd">    CheckStatus.UP means the check is healthy (the number of failures is less</span>
<span class="sd">    than the threshold), CheckStatus.DOWN means the check is unhealthy</span>
<span class="sd">    (the number of failures has reached the threshold).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">failures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of failures since the check last succeeded.&quot;&quot;&quot;</span>

    <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Failure threshold.</span>

<span class="sd">    This is how many consecutive failures for the check to be considered down.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_to_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pebble</span><span class="o">.</span><span class="n">CheckInfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pebble</span><span class="o">.</span><span class="n">CheckInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="n">failures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Container"><a class="viewcode-back" href="../../index.html#scenario.state.Container">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Kubernetes container where a charm&#39;s workload runs.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of the container, as found in the charm metadata.&quot;&quot;&quot;</span>

    <span class="n">can_connect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;When False, all Pebble operations will fail.&quot;&quot;&quot;</span>

    <span class="c1"># This is the base plan. On top of it, one can add layers.</span>
    <span class="c1"># We need to model pebble in this way because it&#39;s impossible to retrieve the layers from</span>
    <span class="c1"># pebble or derive them from the resulting plan (which one CAN get from pebble).</span>
    <span class="c1"># So if we are instantiating Container by fetching info from a &#39;live&#39; charm, the &#39;layers&#39;</span>
    <span class="c1"># will be unknown. all that we can know is the resulting plan (the &#39;computed plan&#39;).</span>
    <span class="n">_base_plan</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># We expect most of the user-facing testing to be covered by this &#39;layers&#39; attribute,</span>
    <span class="c1"># as all will be known when unit-testing.</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pebble</span><span class="o">.</span><span class="n">Layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All :class:`ops.pebble.Layer` definitions that have already been added to the container.&quot;&quot;&quot;</span>

    <span class="n">service_status</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceStatus</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The current status of each Pebble service running in the container.&quot;&quot;&quot;</span>

    <span class="c1"># when the charm runs `pebble.pull`, it will return .open() from one of these paths.</span>
    <span class="c1"># when the charm pushes, it will either overwrite one of those paths (careful!) or it will</span>
    <span class="c1"># create a tempfile and insert its path in the mock filesystem tree</span>
    <span class="n">mounts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Mount</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides access to the contents of the simulated container filesystem.</span>

<span class="sd">    For example, suppose you want to express that your container has:</span>

<span class="sd">    * ``/home/foo/bar.py``</span>
<span class="sd">    * ``/bin/bash``</span>
<span class="sd">    * ``/bin/baz``</span>

<span class="sd">    this becomes::</span>

<span class="sd">        mounts = {</span>
<span class="sd">            &#39;foo&#39;: scenario.Mount(&#39;/home/foo&#39;,  Path(&#39;/path/to/local/dir/containing/bar/py/&#39;)),</span>
<span class="sd">            &#39;bin&#39;: Mount(&#39;/bin/&#39;, Path(&#39;/path/to/local/dir/containing/bash/and/baz/&#39;)),</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exec_mock</span><span class="p">:</span> <span class="n">_ExecMock</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate executing commands in the container.</span>

<span class="sd">    Specify each command the charm might run in the container and a :class:`ExecOutput`</span>
<span class="sd">    containing its return code and any stdout/stderr.</span>

<span class="sd">    For example::</span>

<span class="sd">        container = scenario.Container(</span>
<span class="sd">            name=&#39;foo&#39;,</span>
<span class="sd">            exec_mock={</span>
<span class="sd">                (&#39;whoami&#39;, ): scenario.ExecOutput(return_code=0, stdout=&#39;ubuntu&#39;)</span>
<span class="sd">                (&#39;dig&#39;, &#39;+short&#39;, &#39;canonical.com&#39;):</span>
<span class="sd">                    scenario.ExecOutput(return_code=0, stdout=&#39;185.125.190.20\\n185.125.190.21&#39;)</span>
<span class="sd">            }</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">notices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Notice</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">check_infos</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">CheckInfo</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_render_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># copied over from ops.testing._TestingPebbleClient._render_services()</span>
        <span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, pebble.Service]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
        <span class="k">return</span> <span class="n">services</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pebble</span><span class="o">.</span><span class="n">Plan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The &#39;computed&#39; Pebble plan.</span>

<span class="sd">        i.e. the base plan plus the layers that have been added on top.</span>
<span class="sd">        You should run your assertions on this plan, not so much on the layers, as those are</span>
<span class="sd">        input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># copied over from ops.testing._TestingPebbleClient.get_plan().</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">Plan</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_plan</span><span class="p">))</span>
        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_services</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">services</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plan</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">plan</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">plan</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">services</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Pebble services as rendered in the plan.&quot;&quot;&quot;</span>
        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_services</span><span class="p">()</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, pebble.ServiceInfo]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># in pebble, it just returns &quot;nothing matched&quot; if there are 0 matches,</span>
                <span class="c1"># but it ignores services it doesn&#39;t recognize</span>
                <span class="k">continue</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceStatus</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">startup</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">startup</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceStartup</span><span class="o">.</span><span class="n">DISABLED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">startup</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceStartup</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">startup</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">pebble</span><span class="o">.</span><span class="n">ServiceInfo</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">startup</span><span class="o">=</span><span class="n">startup</span><span class="p">,</span>
                <span class="n">current</span><span class="o">=</span><span class="n">pebble</span><span class="o">.</span><span class="n">ServiceStatus</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">infos</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">return</span> <span class="n">infos</span>

<div class="viewcode-block" id="Container.get_filesystem"><a class="viewcode-back" href="../../index.html#scenario.state.Container.get_filesystem">[docs]</a>    <span class="k">def</span> <span class="nf">get_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="s2">&quot;Context&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulated Pebble filesystem in this context.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A temporary filesystem containing any files or directories the</span>
<span class="sd">            charm pushed to the container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_get_container_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div></div>


<span class="n">_RawStatusLiteral</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;waiting&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blocked&quot;</span><span class="p">,</span>
    <span class="s2">&quot;active&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maintenance&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_EntityStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class represents StatusBase and should not be interacted with directly.&quot;&quot;&quot;</span>

    <span class="c1"># Why not use StatusBase directly? Because that can&#39;t be used with</span>
    <span class="c1"># dataclasses.asdict to then be JSON-serializable.</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">_RawStatusLiteral</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">_entity_statuses</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;_EntityStatus&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">StatusBase</span><span class="p">,</span> <span class="n">_EntityStatus</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status_type_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Status&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_type_name</span><span class="si">}</span><span class="s2">()&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_type_name</span><span class="si">}</span><span class="s2">(&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_status_name</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">_RawStatusLiteral</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_EntityStatus&quot;</span><span class="p">:</span>
        <span class="c1"># Note that this won&#39;t work for UnknownStatus.</span>
        <span class="c1"># All subclasses have a default &#39;name&#39; attribute, but the type checker can&#39;t tell that.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_entity_statuses</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># type:ignore</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_ops</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">StatusBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_EntityStatus&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_status_name</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">_RawStatusLiteral</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>


<div class="viewcode-block" id="UnknownStatus"><a class="viewcode-back" href="../../index.html#scenario.state.UnknownStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UnknownStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">UnknownStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">UnknownStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="ErrorStatus"><a class="viewcode-back" href="../../index.html#scenario.state.ErrorStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ErrorStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">ErrorStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ErrorStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActiveStatus"><a class="viewcode-back" href="../../index.html#scenario.state.ActiveStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ActiveStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">ActiveStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ActiveStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="BlockedStatus"><a class="viewcode-back" href="../../index.html#scenario.state.BlockedStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BlockedStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">BlockedStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">BlockedStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;blocked&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;blocked&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="MaintenanceStatus"><a class="viewcode-back" href="../../index.html#scenario.state.MaintenanceStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MaintenanceStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaintenanceStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaintenanceStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;maintenance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;maintenance&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;maintenance&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="WaitingStatus"><a class="viewcode-back" href="../../index.html#scenario.state.WaitingStatus">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">WaitingStatus</span><span class="p">(</span><span class="n">_EntityStatus</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">WaitingStatus</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">WaitingStatus</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;waiting&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;waiting&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<span class="n">_EntityStatus</span><span class="o">.</span><span class="n">_entity_statuses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">unknown</span><span class="o">=</span><span class="n">UnknownStatus</span><span class="p">,</span>
    <span class="n">error</span><span class="o">=</span><span class="n">ErrorStatus</span><span class="p">,</span>
    <span class="n">active</span><span class="o">=</span><span class="n">ActiveStatus</span><span class="p">,</span>
    <span class="n">blocked</span><span class="o">=</span><span class="n">BlockedStatus</span><span class="p">,</span>
    <span class="n">maintenance</span><span class="o">=</span><span class="n">MaintenanceStatus</span><span class="p">,</span>
    <span class="n">waiting</span><span class="o">=</span><span class="n">WaitingStatus</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="StoredState"><a class="viewcode-back" href="../../index.html#scenario.state.StoredState">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StoredState</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_stored&quot;</span>

    <span class="c1"># /-separated Object names. E.g. MyCharm/MyCharmLib.</span>
    <span class="c1"># if None, this StoredState instance is owned by the Framework.</span>
    <span class="n">owner_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Ideally, the type here would be only marshallable types, rather than Any.</span>
    <span class="c1"># However, it&#39;s complex to describe those types, since it&#39;s a recursive</span>
    <span class="c1"># definition - even in TypeShed the _Marshallable type includes containers</span>
    <span class="c1"># like list[Any], which seems to defeat the point.</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">_data_type_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;StoredStateData&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handle_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_type_name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_path</span><span class="p">)</span></div>


<span class="n">_RawPortProtocolLiteral</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span> <span class="s2">&quot;udp&quot;</span><span class="p">,</span> <span class="s2">&quot;icmp&quot;</span><span class="p">]</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_Port</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a port on the charm host.&quot;&quot;&quot;</span>

    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The port to open. Required for TCP and UDP; not allowed for ICMP.&quot;&quot;&quot;</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">_RawPortProtocolLiteral</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The protocol that data transferred over the port will use.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">_Port</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;_Port cannot be instantiated directly; &quot;</span>
                <span class="s2">&quot;please use TCPPort, UDPPort, or ICMPPort&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">_Port</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">Port</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="TCPPort"><a class="viewcode-back" href="../../index.html#scenario.state.TCPPort">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TCPPort</span><span class="p">(</span><span class="n">_Port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a TCP port on the charm host.&quot;&quot;&quot;</span>

    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The port to open.&quot;&quot;&quot;</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">_RawPortProtocolLiteral</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The protocol that data transferred over the port will use.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StateValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`port` outside bounds [1:65535], got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="UDPPort"><a class="viewcode-back" href="../../index.html#scenario.state.UDPPort">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UDPPort</span><span class="p">(</span><span class="n">_Port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a UDP port on the charm host.&quot;&quot;&quot;</span>

    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The port to open.&quot;&quot;&quot;</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">_RawPortProtocolLiteral</span> <span class="o">=</span> <span class="s2">&quot;udp&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The protocol that data transferred over the port will use.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StateValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`port` outside bounds [1:65535], got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ICMPPort"><a class="viewcode-back" href="../../index.html#scenario.state.ICMPPort">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ICMPPort</span><span class="p">(</span><span class="n">_Port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an ICMP port on the charm host.&quot;&quot;&quot;</span>

    <span class="n">protocol</span><span class="p">:</span> <span class="n">_RawPortProtocolLiteral</span> <span class="o">=</span> <span class="s2">&quot;icmp&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The protocol that data transferred over the port will use.&quot;&quot;&quot;</span>

    <span class="n">_max_positional_args</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StateValidationError</span><span class="p">(</span><span class="s2">&quot;`port` cannot be set for `ICMPPort`&quot;</span><span class="p">)</span></div>


<span class="n">_port_cls_by_protocol</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tcp&quot;</span><span class="p">:</span> <span class="n">TCPPort</span><span class="p">,</span>
    <span class="s2">&quot;udp&quot;</span><span class="p">:</span> <span class="n">UDPPort</span><span class="p">,</span>
    <span class="s2">&quot;icmp&quot;</span><span class="p">:</span> <span class="n">ICMPPort</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">_next_storage_index_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># storage indices start at 0</span>


<div class="viewcode-block" id="next_storage_index"><a class="viewcode-back" href="../../index.html#scenario.state.next_storage_index">[docs]</a><span class="k">def</span> <span class="nf">next_storage_index</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the index (used to be called ID) the next Storage to be created will get.</span>

<span class="sd">    Pass update=False if you&#39;re only inspecting it.</span>
<span class="sd">    Pass update=True if you also want to bump it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_next_storage_index_counter</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">_next_storage_index_counter</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">_next_storage_index_counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cur</span></div>


<div class="viewcode-block" id="Storage"><a class="viewcode-back" href="../../index.html#scenario.state.Storage">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Storage</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an (attached!) storage made available to the charm container.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">next_storage_index</span><span class="p">)</span>
    <span class="c1"># Every new Storage instance gets a new one, if there&#39;s trouble, override.</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Storage</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">Storage</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Storage.get_filesystem"><a class="viewcode-back" href="../../index.html#scenario.state.Storage.get_filesystem">[docs]</a>    <span class="k">def</span> <span class="nf">get_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="s2">&quot;Context&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulated filesystem root in this context.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_get_storage_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Resource"><a class="viewcode-back" href="../../index.html#scenario.state.Resource">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a resource made available to the charm.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span><span class="p">:</span> <span class="s2">&quot;PathLike&quot;</span></div>


<div class="viewcode-block" id="State"><a class="viewcode-back" href="../../index.html#scenario.state.State">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the juju-owned portion of a unit&#39;s state.</span>

<span class="sd">    Roughly speaking, it wraps all hook-tool- and pebble-mediated data a charm can access in its</span>
<span class="sd">    lifecycle. For example, status-get will return data from `State.status`, is-leader will</span>
<span class="sd">    return data from `State.leader`, and so on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The present configuration of this charm.&quot;&quot;&quot;</span>
    <span class="n">relations</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;AnyRelation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All relations that currently exist for this charm.&quot;&quot;&quot;</span>
    <span class="n">networks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Network</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manual overrides for any relation and extra bindings currently provisioned for this charm.</span>
<span class="sd">    If a metadata-defined relation endpoint is not explicitly mapped to a Network in this field,</span>
<span class="sd">    it will be defaulted.</span>
<span class="sd">    [CAVEAT: `extra-bindings` is a deprecated, regretful feature in juju/ops. For completeness we</span>
<span class="sd">    support it, but use at your own risk.] If a metadata-defined extra-binding is left empty,</span>
<span class="sd">    it will be defaulted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">containers</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Container</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All containers (whether they can connect or not) that this charm is aware of.&quot;&quot;&quot;</span>
    <span class="n">storages</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Storage</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All ATTACHED storage instances for this charm.</span>
<span class="sd">    If a storage is not attached, omit it from this listing.&quot;&quot;&quot;</span>

    <span class="c1"># we don&#39;t use sets to make json serialization easier</span>
    <span class="n">opened_ports</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_Port</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ports opened by juju on this charm.&quot;&quot;&quot;</span>
    <span class="n">leader</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether this charm has leadership.&quot;&quot;&quot;</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The model this charm lives in.&quot;&quot;&quot;</span>
    <span class="n">secrets</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Secret</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The secrets this charm has access to (as an owner, or as a grantee).</span>
<span class="sd">    The presence of a secret in this list entails that the charm can read it.</span>
<span class="sd">    Whether it can manage it or not depends on the individual secret&#39;s `owner` flag.&quot;&quot;&quot;</span>
    <span class="n">resources</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Resource</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All resources that this charm can access.&quot;&quot;&quot;</span>
    <span class="n">planned_units</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of non-dying planned units that are expected to be running this application.</span>
<span class="sd">    Use with caution.&quot;&quot;&quot;</span>

    <span class="c1"># Represents the OF&#39;s event queue. These events will be emitted before the event being</span>
    <span class="c1"># dispatched, and represent the events that had been deferred during the previous run.</span>
    <span class="c1"># If the charm defers any events during &quot;this execution&quot;, they will be appended</span>
    <span class="c1"># to this list.</span>
    <span class="n">deferred</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;DeferredEvent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Events that have been deferred on this charm by some previous execution.&quot;&quot;&quot;</span>
    <span class="n">stored_states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;StoredState&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">,</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contents of a charm&#39;s stored state.&quot;&quot;&quot;</span>

    <span class="c1"># the current statuses.</span>
    <span class="n">app_status</span><span class="p">:</span> <span class="n">_EntityStatus</span> <span class="o">=</span> <span class="n">UnknownStatus</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status of the application.&quot;&quot;&quot;</span>
    <span class="n">unit_status</span><span class="p">:</span> <span class="n">_EntityStatus</span> <span class="o">=</span> <span class="n">UnknownStatus</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status of the unit.&quot;&quot;&quot;</span>
    <span class="n">workload_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Workload version.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Let people pass in the ops classes, and convert them to the appropriate Scenario classes.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;app_status&quot;</span><span class="p">,</span> <span class="s2">&quot;unit_status&quot;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">_EntityStatus</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">StatusBase</span><span class="p">):</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_EntityStatus</span><span class="o">.</span><span class="n">from_ops</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid status.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">normalised_ports</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_Port</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">port</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">Port</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">port</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_ports</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_ports</span> <span class="o">!=</span> <span class="n">normalised_ports</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;opened_ports&quot;</span><span class="p">,</span> <span class="n">normalised_ports</span><span class="p">)</span>
        <span class="n">normalised_storage</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Storage</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">storage</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">storage</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">Storage</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">storage</span>
            <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storages</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storages</span> <span class="o">!=</span> <span class="n">normalised_storage</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;storages&quot;</span><span class="p">,</span> <span class="n">normalised_storage</span><span class="p">)</span>
        <span class="c1"># ops.Container, ops.Model, ops.Relation, ops.Secret should not be instantiated by charmers.</span>
        <span class="c1"># ops.Network does not have the relation name, so cannot be converted.</span>
        <span class="c1"># ops.Resources does not contain the source of the resource, so cannot be converted.</span>
        <span class="c1"># ops.StoredState is not convenient to initialise with data, so not useful here.</span>

        <span class="c1"># It&#39;s convenient to pass a set, but we really want the attributes to be</span>
        <span class="c1"># frozen sets to increase the immutability of State objects.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;relations&quot;</span><span class="p">,</span>
            <span class="s2">&quot;containers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storages&quot;</span><span class="p">,</span>
            <span class="s2">&quot;networks&quot;</span><span class="p">,</span>
            <span class="s2">&quot;opened_ports&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secrets&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resources&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stored_states&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="c1"># It&#39;s ok to pass any iterable (of hashable objects), but you&#39;ll get</span>
            <span class="c1"># a frozenset as the actual attribute.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">):</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_update_workload_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_workload_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current app version and record the previous one.&quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t keep a full history because we don&#39;t expect the app version to change more</span>
        <span class="c1"># than once per hook.</span>

        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;workload_version&quot;</span><span class="p">,</span> <span class="n">new_workload_version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_status</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_status</span><span class="p">:</span> <span class="n">_EntityStatus</span><span class="p">,</span>
        <span class="n">is_app</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current app/unit status.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;app_status&quot;</span> <span class="k">if</span> <span class="n">is_app</span> <span class="k">else</span> <span class="s2">&quot;unit_status&quot;</span>
        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_opened_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ports</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">_Port</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current opened ports.&quot;&quot;&quot;</span>
        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;opened_ports&quot;</span><span class="p">,</span> <span class="n">new_ports</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_secrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_secrets</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">Secret</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the current secrets.&quot;&quot;&quot;</span>
        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="n">new_secrets</span><span class="p">)</span>

<div class="viewcode-block" id="State.with_can_connect"><a class="viewcode-back" href="../../index.html#scenario.state.State.with_can_connect">[docs]</a>    <span class="k">def</span> <span class="nf">with_can_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">can_connect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;State&quot;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">replacer</span><span class="p">(</span><span class="n">container</span><span class="p">:</span> <span class="n">Container</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">container_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">can_connect</span><span class="o">=</span><span class="n">can_connect</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">container</span>

        <span class="n">ctrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">replacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">containers</span><span class="o">=</span><span class="n">ctrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.with_leadership"><a class="viewcode-back" href="../../index.html#scenario.state.State.with_leadership">[docs]</a>    <span class="k">def</span> <span class="nf">with_leadership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leader</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;State&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leader</span><span class="o">=</span><span class="n">leader</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.with_unit_status"><a class="viewcode-back" href="../../index.html#scenario.state.State.with_unit_status">[docs]</a>    <span class="k">def</span> <span class="nf">with_unit_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">StatusBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;State&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">unit_status</span><span class="o">=</span><span class="n">_EntityStatus</span><span class="o">.</span><span class="n">from_ops</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="State.get_container"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_container">[docs]</a>    <span class="k">def</span> <span class="nf">get_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Container</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get container from this State, based on its name.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state_container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_container</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">container</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_container</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;container: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2"> not found in the State&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.get_network"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_network">[docs]</a>    <span class="k">def</span> <span class="nf">get_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Network</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get network from this State, based on its binding name.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">network</span><span class="o">.</span><span class="n">binding_name</span> <span class="o">==</span> <span class="n">binding_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">network</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;network: </span><span class="si">{</span><span class="n">binding_name</span><span class="si">}</span><span class="s2"> not found in the State&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.get_secret"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_secret">[docs]</a>    <span class="k">def</span> <span class="nf">get_secret</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Secret</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get secret from this State, based on the secret&#39;s id or label.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;An id or label must be provided.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">secret</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="nb">id</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">secret</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">secret</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="nb">id</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">secret</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">secret</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">secret</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;secret: not found in the State&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.get_stored_state"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_stored_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_stored_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stored_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">owner_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StoredState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get stored state from this State, based on the stored state&#39;s name and owner_path.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">stored_state</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">owner_path</span> <span class="o">==</span> <span class="n">owner_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ss</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stored state: </span><span class="si">{</span><span class="n">stored_state</span><span class="si">}</span><span class="s2"> not found in the State&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.get_storage"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_storage">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">storage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Storage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get storage from this State, based on the storage&#39;s name and index.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state_storage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_storage</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">storage</span> <span class="ow">and</span> <span class="n">storage</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_storage</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;storage: name=</span><span class="si">{</span><span class="n">storage</span><span class="si">}</span><span class="s2">, index=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> not found in the State&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="State.get_relation"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_relation">[docs]</a>    <span class="k">def</span> <span class="nf">get_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AnyRelation&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get relation from this State, based on the relation&#39;s id.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state_relation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_relation</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">relation</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_relation</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;relation: id=</span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> not found in the State&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.get_relations"><a class="viewcode-back" href="../../index.html#scenario.state.State.get_relations">[docs]</a>    <span class="k">def</span> <span class="nf">get_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;AnyRelation&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all relations on this endpoint from the current state.&quot;&quot;&quot;</span>

        <span class="c1"># we rather normalize the endpoint than worry about cursed metadata situations such as:</span>
        <span class="c1"># requires:</span>
        <span class="c1">#   foo-bar: ...</span>
        <span class="c1">#   foo_bar: ...</span>

        <span class="n">normalized_endpoint</span> <span class="o">=</span> <span class="n">normalize_name</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">r</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span>
            <span class="k">if</span> <span class="n">normalize_name</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span> <span class="o">==</span> <span class="n">normalized_endpoint</span>
        <span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_is_valid_charmcraft_25_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="c1"># Check whether this dict has the expected mandatory metadata fields according to the</span>
    <span class="c1"># charmcraft &gt;2.5 charmcraft.yaml schema</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config_type</span> <span class="o">:=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">&quot;charm&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Not a charm: charmcraft yaml config ``.type`` is </span><span class="si">{</span><span class="n">config_type</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">}):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not a charm: charmcraft yaml misses some required fields&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_CharmSpec</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">CharmType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Charm spec.&quot;&quot;&quot;</span>

    <span class="n">charm_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">CharmBase</span><span class="p">]</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">actions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># autoloaded means: we are running a &#39;real&#39; charm class, living in some</span>
    <span class="c1"># /src/charm.py, and the metadata files are &#39;real&#39; metadata files.</span>
    <span class="n">is_autoloaded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_metadata_legacy</span><span class="p">(</span><span class="n">charm_root</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load metadata from charm projects created with Charmcraft &lt; 2.5.&quot;&quot;&quot;</span>
        <span class="c1"># back in the days, we used to have separate metadata.yaml, config.yaml and actions.yaml</span>
        <span class="c1"># files for charm metadata.</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">charm_root</span> <span class="o">/</span> <span class="s2">&quot;metadata.yaml&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">metadata_path</span><span class="o">.</span><span class="n">open</span><span class="p">())</span> <span class="k">if</span> <span class="n">metadata_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">config_path</span> <span class="o">=</span> <span class="n">charm_root</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_path</span><span class="o">.</span><span class="n">open</span><span class="p">())</span> <span class="k">if</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">actions_path</span> <span class="o">=</span> <span class="n">charm_root</span> <span class="o">/</span> <span class="s2">&quot;actions.yaml&quot;</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">actions_path</span><span class="o">.</span><span class="n">open</span><span class="p">())</span> <span class="k">if</span> <span class="n">actions_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">meta</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">actions</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_metadata</span><span class="p">(</span><span class="n">charm_root</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load metadata from charm projects created with Charmcraft &gt;= 2.5.&quot;&quot;&quot;</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">charm_root</span> <span class="o">/</span> <span class="s2">&quot;charmcraft.yaml&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">metadata_path</span><span class="o">.</span><span class="n">open</span><span class="p">())</span> <span class="k">if</span> <span class="n">metadata_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_valid_charmcraft_25_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">actions</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">autoload</span><span class="p">(</span><span class="n">charm_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">CharmBase</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;_CharmSpec[CharmType]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a ``_CharmSpec`` object by looking up the metadata from the charm&#39;s repo root.</span>

<span class="sd">        Will attempt to load the metadata off the ``charmcraft.yaml`` file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">charm_source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">charm_type</span><span class="p">))</span>
        <span class="n">charm_root</span> <span class="o">=</span> <span class="n">charm_source_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>

        <span class="c1"># attempt to load metadata from unified charmcraft.yaml</span>
        <span class="n">meta</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">_CharmSpec</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">(</span><span class="n">charm_root</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
            <span class="c1"># try to load using legacy metadata.yaml/actions.yaml/config.yaml files</span>
            <span class="n">meta</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">_CharmSpec</span><span class="o">.</span><span class="n">_load_metadata_legacy</span><span class="p">(</span><span class="n">charm_root</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">:</span>
            <span class="c1"># still no metadata? bug out</span>
            <span class="k">raise</span> <span class="n">MetadataNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;invalid charm root </span><span class="si">{</span><span class="n">charm_root</span><span class="si">!r}</span><span class="s2">; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;expected to contain at least a `charmcraft.yaml` file &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(or a `metadata.yaml` file if it&#39;s an old charm).&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_CharmSpec</span><span class="p">(</span>
            <span class="n">charm_type</span><span class="o">=</span><span class="n">charm_type</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">is_autoloaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of all relation endpoints defined in the metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">chain</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;provides&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peers&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="p">),</span>
        <span class="p">)</span>


<div class="viewcode-block" id="DeferredEvent"><a class="viewcode-back" href="../../index.html#scenario.state.DeferredEvent">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DeferredEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An event that has been deferred to run prior to the next Juju event.</span>

<span class="sd">    In most cases, the :func:`deferred` function should be used to create a</span>
<span class="sd">    ``DeferredEvent`` instance.&quot;&quot;&quot;</span>

    <span class="n">handle_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">observer</span><span class="p">:</span> <span class="nb">str</span>

    <span class="c1"># needs to be marshal.dumps-able.</span>
    <span class="n">snapshot_data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">_EventType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">framework</span> <span class="o">=</span> <span class="s2">&quot;framework&quot;</span>
    <span class="n">builtin</span> <span class="o">=</span> <span class="s2">&quot;builtin&quot;</span>
    <span class="n">relation</span> <span class="o">=</span> <span class="s2">&quot;relation&quot;</span>
    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;action&quot;</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="s2">&quot;storage&quot;</span>
    <span class="n">workload</span> <span class="o">=</span> <span class="s2">&quot;workload&quot;</span>
    <span class="n">custom</span> <span class="o">=</span> <span class="s2">&quot;custom&quot;</span>


<span class="k">class</span> <span class="nc">_EventPath</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">owner_path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">is_custom</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">_EventType</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">normalize_name</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">owner_path</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">]</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_EventPath</span><span class="o">.</span><span class="n">_get_suffix_and_type</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">string</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">is_custom</span> <span class="o">=</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_suffix_and_type</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_EventType</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">RELATION_EVENTS_SUFFIX</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">relation</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ACTION_EVENT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ACTION_EVENT_SUFFIX</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">action</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SECRET_EVENTS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">secret</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">FRAMEWORK_EVENTS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">framework</span>

        <span class="c1"># Whether the event name indicates that this is a storage event.</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">STORAGE_EVENTS_SUFFIX</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">storage</span>

        <span class="c1"># Whether the event name indicates that this is a workload event.</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">PEBBLE_READY_EVENT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PEBBLE_READY_EVENT_SUFFIX</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">workload</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">PEBBLE_CUSTOM_NOTICE_EVENT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PEBBLE_CUSTOM_NOTICE_EVENT_SUFFIX</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">workload</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">PEBBLE_CHECK_FAILED_EVENT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PEBBLE_CHECK_FAILED_EVENT_SUFFIX</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">workload</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">PEBBLE_CHECK_RECOVERED_EVENT_SUFFIX</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PEBBLE_CHECK_RECOVERED_EVENT_SUFFIX</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">workload</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">BUILTIN_EVENTS</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">builtin</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">custom</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_Event</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Juju, ops, or custom event that can be run against a charm.</span>

<span class="sd">    Typically, for simple events, the string name (e.g. ``install``) can be used,</span>
<span class="sd">    and for more complex events, an ``event`` property will be available on the</span>
<span class="sd">    related object (e.g. ``relation.joined_event``).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">storage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Storage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a storage event, the storage it refers to.&quot;&quot;&quot;</span>
    <span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;AnyRelation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a relation event, the relation it refers to.&quot;&quot;&quot;</span>
    <span class="n">relation_remote_unit_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">relation_departed_unit_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a relation event, the name of the remote unit the event is about.&quot;&quot;&quot;</span>

    <span class="n">secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Secret</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">secret_revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a secret event, the secret it refers to.&quot;&quot;&quot;</span>

    <span class="n">container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Container</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a workload (container) event, the container it refers to.&quot;&quot;&quot;</span>

    <span class="n">notice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Notice</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a Pebble notice event, the notice it refers to.&quot;&quot;&quot;</span>

    <span class="n">check_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CheckInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is a Pebble check event, the check info it provides.&quot;&quot;&quot;</span>

    <span class="n">action</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;_Action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If this is an action event, the :class:`Action` it refers to.&quot;&quot;&quot;</span>

    <span class="n">_owner_path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_EventPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># bypass frozen dataclass</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_EventPath</span><span class="p">:</span>
        <span class="c1"># we converted it in __post_init__, but the type checker doesn&#39;t know about that</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_EventPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Full event name.</span>

<span class="sd">        Consists of a &#39;prefix&#39; and a &#39;suffix&#39;. The suffix denotes the type of the event, the</span>
<span class="sd">        prefix the name of the entity the event is about.</span>

<span class="sd">        &quot;foo-relation-changed&quot;:</span>
<span class="sd">         - &quot;foo&quot;=prefix (name of a relation),</span>
<span class="sd">         - &quot;-relation-changed&quot;=suffix (relation event)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">owner_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the ObjectEvents instance owning this event.</span>

<span class="sd">        If this event is defined on the toplevel charm class, it should be [&#39;on&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">owner_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_relation_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the event name indicates that this is a relation event.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">relation</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_action_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the event name indicates that this is a relation event.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">action</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_secret_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the event name indicates that this is a secret event.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">secret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_storage_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the event name indicates that this is a storage event.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_workload_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the event name indicates that this is a workload event.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">workload</span>

    <span class="c1"># this method is private because _CharmSpec is not quite user-facing; also,</span>
    <span class="c1"># the user should know.</span>
    <span class="k">def</span> <span class="nf">_is_builtin_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charm_spec</span><span class="p">:</span> <span class="s2">&quot;_CharmSpec&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether the event is a custom-defined one or a builtin one.&quot;&quot;&quot;</span>
        <span class="n">event_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># simple case: this is an event type owned by our charm base.on</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">charm_spec</span><span class="o">.</span><span class="n">charm_type</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">CharmEvents</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>

        <span class="c1"># this could be an event defined on some other Object, e.g. a charm lib.</span>
        <span class="c1"># We don&#39;t support (yet) directly emitting those, but they COULD have names that conflict</span>
        <span class="c1"># with events owned by the base charm. E.g. if the charm has a `foo` relation, the charm</span>
        <span class="c1"># will get a  charm.on.foo_relation_created. Your charm lib is free to define its own</span>
        <span class="c1"># `foo_relation_created`  custom event, because its handle will be</span>
        <span class="c1"># `charm.lib.on.foo_relation_created` and therefore be  unique and the Framework is happy.</span>
        <span class="c1"># However, our Event data structure ATM has no knowledge of which Object/Handle it is</span>
        <span class="c1"># owned by. So the only thing we can do right now is: check whether the event name,</span>
        <span class="c1"># assuming it is owned by the charm, LOOKS LIKE that of a builtin event or not.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_EventType</span><span class="o">.</span><span class="n">custom</span>

    <span class="k">def</span> <span class="nf">deferred</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeferredEvent</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a DeferredEvent from this Event.&quot;&quot;&quot;</span>
        <span class="n">handler_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">handler_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;function (.*) at .*&gt;&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">handler_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">handler_repr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;cannot construct DeferredEvent from </span><span class="si">{</span><span class="n">handler</span><span class="si">}</span><span class="s2">; please create one manually.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">owner_name</span><span class="p">,</span> <span class="n">handler_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">handle_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_name</span><span class="si">}</span><span class="s2">/on/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">snapshot_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># fixme: at this stage we can&#39;t determine if the event is a builtin one or not; if it is</span>
        <span class="c1">#  not, then the coming checks are meaningless: the custom event could be named like a</span>
        <span class="c1">#  relation event but not *be* one.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_workload_event</span><span class="p">:</span>
            <span class="c1"># this is a WorkloadEvent. The snapshot:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Container</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span>
            <span class="n">snapshot_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;container_name&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>
                    <span class="n">notice_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">pebble</span><span class="o">.</span><span class="n">NoticeType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">notice_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="n">snapshot_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;notice_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;notice_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">notice</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;notice_type&quot;</span><span class="p">:</span> <span class="n">notice_type</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_info</span><span class="p">:</span>
                <span class="n">snapshot_data</span><span class="p">[</span><span class="s2">&quot;check_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_info</span><span class="o">.</span><span class="n">name</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_relation_event</span><span class="p">:</span>
            <span class="c1"># this is a RelationEvent.</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;AnyRelation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">PeerRelation</span><span class="p">):</span>
                <span class="c1"># FIXME: relation.unit for peers should point to &lt;this unit&gt;, but we</span>
                <span class="c1">#  don&#39;t have access to the local app name in this context.</span>
                <span class="n">remote_app</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remote_app</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">remote_app_name</span>

            <span class="n">snapshot_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;relation_name&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                <span class="s2">&quot;relation_id&quot;</span><span class="p">:</span> <span class="n">relation</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;app_name&quot;</span><span class="p">:</span> <span class="n">remote_app</span><span class="p">,</span>
                <span class="s2">&quot;unit_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_app</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">relation_remote_unit_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">DeferredEvent</span><span class="p">(</span>
            <span class="n">handle_path</span><span class="p">,</span>
            <span class="n">owner_name</span><span class="p">,</span>
            <span class="n">handler_name</span><span class="p">,</span>
            <span class="n">snapshot_data</span><span class="o">=</span><span class="n">snapshot_data</span><span class="p">,</span>
        <span class="p">)</span>


<span class="n">_next_action_id_counter</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="next_action_id"><a class="viewcode-back" href="../../index.html#scenario.state.next_action_id">[docs]</a><span class="k">def</span> <span class="nf">next_action_id</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_next_action_id_counter</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">_next_action_id_counter</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">_next_action_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Juju currently uses numbers for the ID, but in the past used UUIDs, so</span>
    <span class="c1"># we need these to be strings.</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_Action</span><span class="p">(</span><span class="n">_max_posargs</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A ``juju run`` command.</span>

<span class="sd">    Used to simulate ``juju run``, passing in any parameters. For example::</span>

<span class="sd">        def test_backup_action():</span>
<span class="sd">            ctx = scenario.Context(MyCharm)</span>
<span class="sd">            state = ctx.run(</span>
<span class="sd">                ctx.on.action(&#39;do_backup&#39;, params={&#39;filename&#39;: &#39;foo&#39;}),</span>
<span class="sd">                scenario.State()</span>
<span class="sd">            )</span>
<span class="sd">            assert ctx.action_history[0].results == ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Juju action name, as found in the charm metadata.&quot;&quot;&quot;</span>

    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;AnyJson&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameter values passed to the action.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">next_action_id</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Juju action ID.</span>

<span class="sd">    Every action invocation is automatically assigned a new one. Override in</span>
<span class="sd">    the rare cases where a specific ID is required.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="deferred"><a class="viewcode-back" href="../../index.html#scenario.state.deferred">[docs]</a><span class="k">def</span> <span class="nf">deferred</span><span class="p">(</span>
    <span class="n">event</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Event</span><span class="p">],</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">relation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Relation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Container&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">notice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Notice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">check_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;CheckInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a DeferredEvent from an Event or an event name.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">_Event</span><span class="p">(</span>
            <span class="n">event</span><span class="p">,</span>
            <span class="n">relation</span><span class="o">=</span><span class="n">relation</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
            <span class="n">notice</span><span class="o">=</span><span class="n">notice</span><span class="p">,</span>
            <span class="n">check_info</span><span class="o">=</span><span class="n">check_info</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
   

<div class="related-pages">
  
  
  
  
</div>
<div class="bottom-of-page">
  <div class="left-details">
    <div class="copyright">
        Copyright &#169; 2024, Canonical Ltd.
    </div>

    <div class="last-updated">
      Last updated on Aug 02, 2024</div>
  </div>
  <div class="right-details">

    

    
    <div class="ask-discourse">
      <a class="muted-link" href="https://discourse.charmhub.io/">Ask a question on Discourse</a>
    </div>
    

    

    
    <div class="ask-matrix">
      <a class="muted-link" href="https://matrix.to/#/#charmhub-charmdev:ubuntu.com">Ask a question on Matrix</a>
    </div>
    

    

    
    <div class="issue-github">
      <a class="muted-link" href="https://github.com/canonical/ops-scenario/issues/new?title=doc%3A+ADD+A+TITLE&body=DESCRIBE+THE+ISSUE%0A%0A---%0ADocument: _modules/scenario/state">Open a GitHub issue for this page</a>
    </div>
    

    <div class="edit-github">
      <a class="muted-link" href="https://github.com/canonical/ops-scenario/edit/main/docs/_modules/scenario/state">Edit this page on GitHub</a>
    </div>
    


    </div>
  </div>
</div>

      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
<div class="toc-sticky toc-scroll">
   
    <div class="toc-title-container">
      <span class="toc-title">
       Contents
      </span>
    </div>
    <div class="toc-tree-container">
      <div class="toc-tree">
        
      </div>
    </div>
   
    
  </div>

    </aside>
  </div>
</div><script src="../../_static/jquery.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="../../_static/header-nav.js"></script>
    <script src="../../_static/github_issue_links.js"></script>
    
<script>
  const github_url = "https://github.com/canonical/ops-scenario";
</script>
</body>
</html>